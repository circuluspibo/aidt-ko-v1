<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI í˜ë¥´ì†Œë‚˜ ì±—ë´‡</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.3s ease;
        }
        
        .light { background: #f8f9fa; color: #333; }
        .dark { background: #1a1a1a; color: #fff; }
        
        .header {
            position: sticky;
            top: 0;
            padding: 1rem;
            border-bottom: 1px solid;
            backdrop-filter: blur(10px);
            z-index: 50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .light .header { background: rgba(255,255,255,0.9); border-color: #e0e0e0; }
        .dark .header { background: rgba(26,26,26,0.9); border-color: #333; }
        
        .btn {
            padding: 0.5rem;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 0.25rem;
        }
        
        .light .btn { background: #f0f0f0; color: #333; }
        .dark .btn { background: #333; color: #fff; }
        .btn:hover { transform: scale(1.1); }
        
        .personas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        
        .persona-card {
            padding: 1rem;
            border-radius: 1rem;
            border: 2px solid;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .light .persona-card { background: #fff; border-color: #e0e0e0; }
        .dark .persona-card { background: #2a2a2a; border-color: #444; }
        .persona-card:hover { transform: scale(1.05); border-color: #8b5cf6; }
        
        .chat-container {
            height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .message {
            margin: 1rem 0;
            display: flex;
        }
        
        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }
        
        .message-content {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        
        .message.user .message-content { background: #8b5cf6; color: white; }
        .light .message.bot .message-content { background: #f0f0f0; color: #333; }
        .dark .message.bot .message-content { background: #333; color: #fff; }
        
        .input-area {
            padding: 1rem;
            border-top: 1px solid;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .light .input-area { background: #fff; border-color: #e0e0e0; }
        .dark .input-area { background: #1a1a1a; border-color: #333; }
        
        .message-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid;
            border-radius: 2rem;
            outline: none;
        }
        
        .light .message-input { background: #fff; border-color: #ccc; color: #333; }
        .dark .message-input { background: #2a2a2a; border-color: #555; color: #fff; }
        
        .send-btn {
            padding: 0.75rem;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .modal-content {
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            width: 400px;
        }
        
        .light .modal-content { background: #fff; }
        .dark .modal-content { background: #2a2a2a; }
        
        .form-input {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 1px solid;
            border-radius: 0.5rem;
            outline: none;
        }
        
        .light .form-input { background: #fff; border-color: #ccc; color: #333; }
        .dark .form-input { background: #1a1a1a; border-color: #555; color: #fff; }
        
        .hidden { display: none; }
        .loading { opacity: 0.7; }
        
        .typing {
            display: flex;
            gap: 4px;
            padding: 1rem;
        }
        
        .typing div {
            width: 8px;
            height: 8px;
            background: #8b5cf6;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing div:nth-child(2) { animation-delay: 0.2s; }
        .typing div:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .recording { 
            background: #ef4444 !important; 
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="light">
    <header class="header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <button id="backBtn" class="btn hidden">â†</button>
            <h1 id="title">AI í˜ë¥´ì†Œë‚˜</h1>
        </div>
        <div style="display: flex; align-items: center;">
            <button id="ttsBtn" class="btn hidden">ğŸ”Š</button>
            <button id="qrBtn" class="btn hidden">ğŸ“±</button>
            <button id="profileBtn" class="btn">ğŸ‘¤</button>
            <button id="themeBtn" class="btn">ğŸŒ™</button>
        </div>
    </header>

    <div id="personasView">
        <div style="padding: 1rem;">
            <h2>ë‚˜ë§Œì˜ AI ì¹œêµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
            <p style="color: #666; margin: 0.5rem 0;">50ëª…ì˜ ë‹¤ì–‘í•œ í˜ë¥´ì†Œë‚˜ì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”</p>
        </div>
        <div id="personasGrid" class="personas-grid"></div>
    </div>

    <div id="chatView" class="hidden">
        <div class="chat-container">
            <div id="messages" class="messages"></div>
            <div class="input-area">
                <button id="micBtn" class="btn">ğŸ¤</button>
                <input id="messageInput" class="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
                <button id="sendBtn" class="send-btn">ğŸ“¤</button>
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal hidden">
        <div class="modal-content">
            <h3>í”„ë¡œí•„ ì„¤ì •</h3>
            <input id="nameInput" class="form-input" placeholder="ì´ë¦„" />
            <input id="ageInput" class="form-input" type="number" placeholder="ë‚˜ì´" />
            <select id="genderInput" class="form-input">
                <option value="">ì„±ë³„ ì„ íƒ</option>
                <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                <option value="ì—¬ì„±">ì—¬ì„±</option>
            </select>
            <textarea id="interestsInput" class="form-input" placeholder="ê´€ì‹¬ì‚¬" rows="3"></textarea>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button id="cancelProfile" class="btn" style="flex: 1; border-radius: 0.5rem;">ì·¨ì†Œ</button>
                <button id="saveProfile" class="btn" style="flex: 1; border-radius: 0.5rem; background: #8b5cf6; color: white;">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="qrModal" class="modal hidden">
        <div class="modal-content" style="text-align: center;">
            <h3 id="qrTitle">í˜ë¥´ì†Œë‚˜ ê³µìœ í•˜ê¸°</h3>
            <img id="qrImage" style="margin: 1rem 0; border: 2px solid #ccc; border-radius: 0.5rem;" />
            <p style="color: #666; margin-bottom: 1rem;">QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ëŒ€í™”í•´ë³´ì„¸ìš”!</p>
            <button id="closeQR" class="btn" style="width: 100%; border-radius: 0.5rem; background: #8b5cf6; color: white;">ë‹«ê¸°</button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/15.0.7/marked.min.js" integrity="sha512-rPuOZPx/WHMHNx2RoALKwiCDiDrCo4ekUctyTYKzBo8NGA79NcTW2gfrbcCL2RYL7RdjX2v9zR0fKyI4U4kPew==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        var currentView = 'personas';
        var selectedPersona = null;
        var messages = [];
        const history = [];
        var isDarkTheme = false;
        var isTTSEnabled = true;
        var isRecording = false;
        var userProfile = { name: '', age: '', gender: '', interests: '' };
        var recognition = null;
        let audio = 0

        const persona = {
            male: [
              { id: 'm1', name: 'ê¹€ë„í˜„', job: 'ì˜ì‚¬', age: 32, personality: 'ë”°ëœ»í•˜ê³  ì‹ ì¤‘í•œ', avatar: 'ğŸ‘¨â€âš•ï¸', desc: 'í™˜ìë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ìƒê°í•˜ëŠ” ë‚´ê³¼ ì „ë¬¸ì˜' },
              { id: 'm2', name: 'ë°•ì¤€í˜¸', job: 'ê°œë°œì', age: 28, personality: 'ì°½ì˜ì ì´ê³  ë…¼ë¦¬ì ì¸', avatar: 'ğŸ‘¨â€ğŸ’»', desc: 'í˜ì‹ ì ì¸ ì†”ë£¨ì…˜ì„ ë§Œë“œëŠ” í’€ìŠ¤íƒ ê°œë°œì' },
              { id: 'm3', name: 'ì´ìŠ¹ë¯¼', job: 'ë³€í˜¸ì‚¬', age: 35, personality: 'ì •ì˜ë¡­ê³  ì¹´ë¦¬ìŠ¤ë§ˆ ìˆëŠ”', avatar: 'ğŸ‘¨â€ğŸ’¼', desc: 'ì •ì˜ë¥¼ ìœ„í•´ ì‹¸ìš°ëŠ” í˜•ì‚¬ì „ë¬¸ ë³€í˜¸ì‚¬' },
              { id: 'm4', name: 'ìµœí˜„ìš°', job: 'ìš”ë¦¬ì‚¬', age: 30, personality: 'ì—´ì •ì ì´ê³  ì„¬ì„¸í•œ', avatar: 'ğŸ‘¨â€ğŸ³', desc: 'ë¯¸ìŠë­ ìŠ¤íƒ€ ë ˆìŠ¤í† ë‘ì˜ ìˆ˜ì„ ì…°í”„' },
              { id: 'm5', name: 'ê°•íƒœìœ¤', job: 'ì†Œë°©ê´€', age: 29, personality: 'ìš©ê°í•˜ê³  ì±…ì„ê° ê°•í•œ', avatar: 'ğŸ‘¨â€ğŸš’', desc: 'ì‹œë¯¼ì˜ ì•ˆì „ì„ ì§€í‚¤ëŠ” ë² í…Œë‘ ì†Œë°©ê´€' },
              { id: 'm6', name: 'ìœ¤ì„œì¤€', job: 'êµì‚¬', age: 31, personality: 'ì¸ë‚´ì‹¬ ë§ê³  ì¹œê·¼í•œ', avatar: 'ğŸ‘¨â€ğŸ«', desc: 'í•™ìƒë“¤ì„ ì‚¬ë‘í•˜ëŠ” ê³ ë“±í•™êµ êµ­ì–´êµì‚¬' },
              { id: 'm7', name: 'ì •ë¯¼ì¬', job: 'ê²½ì°°ê´€', age: 33, personality: 'ì •ì§í•˜ê³  ì˜ë¦¬ ìˆëŠ”', avatar: 'ğŸ‘®â€â™‚ï¸', desc: 'ì‹œë¯¼ì„ ë³´í˜¸í•˜ëŠ” ê°•ë ¥ê³„ í˜•ì‚¬' },
              { id: 'm8', name: 'í•œì§€í›ˆ', job: 'íŒŒì¼ëŸ¿', age: 34, personality: 'ì¹¨ì°©í•˜ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ”', avatar: 'ğŸ‘¨â€âœˆï¸', desc: '15ë…„ ê²½ë ¥ì˜ êµ­ì œì„  ê¸°ì¥' },
              { id: 'm9', name: 'ì†¡ë¯¼í˜¸', job: 'ê±´ì¶•ê°€', age: 36, personality: 'ì˜ˆìˆ ì ì´ê³  ì™„ë²½ì£¼ì˜ì ì¸', avatar: 'ğŸ‘·â€â™‚ï¸', desc: 'í˜ì‹ ì ì¸ ë””ìì¸ìœ¼ë¡œ ìœ ëª…í•œ ê±´ì¶•ê°€' },
              { id: 'm10', name: 'ê¹€í˜„ì„±', job: 'ìš´ë™ì„ ìˆ˜', age: 26, personality: 'í™œë°œí•˜ê³  ê¸ì •ì ì¸', avatar: 'âš½', desc: 'êµ­ê°€ëŒ€í‘œ ì¶•êµ¬ì„ ìˆ˜' },
              { id: 'm11', name: 'ì´ë™í˜', job: 'ìŒì•…ê°€', age: 27, personality: 'ê°ì„±ì ì´ê³  ë¡œë§¨í‹±í•œ', avatar: 'ğŸ¸', desc: 'ì¸ë””ë°´ë“œì˜ ë³´ì»¬ ê²¸ ê¸°íƒ€ë¦¬ìŠ¤íŠ¸' },
              { id: 'm12', name: 'ë°•ì„±í˜¸', job: 'ì‚¬ì—…ê°€', age: 38, personality: 'ì•¼ì‹¬ì°¬ì´ê³  ë¦¬ë”ì‹­ ìˆëŠ”', avatar: 'ğŸ’¼', desc: 'IT ìŠ¤íƒ€íŠ¸ì—… CEO' },
              { id: 'm13', name: 'ìµœì›ì¤€', job: 'ìˆ˜ì˜ì‚¬', age: 30, personality: 'ë™ë¬¼ì„ ì‚¬ë‘í•˜ëŠ” ì˜¨í™”í•œ', avatar: 'ğŸ‘¨â€âš•ï¸', desc: 'ë™ë¬¼ë³‘ì› ì›ì¥' },
              { id: 'm14', name: 'ê°•ë¯¼ìˆ˜', job: 'ì‚¬ì§„ì‘ê°€', age: 29, personality: 'ì˜ˆìˆ ì ì´ê³  ììœ ë¡œìš´', avatar: 'ğŸ“¸', desc: 'ì—¬í–‰ ì „ë¬¸ ì‚¬ì§„ì‘ê°€' },
              { id: 'm15', name: 'ìœ¤ì¤€ì˜', job: 'ê¸°ì', age: 32, personality: 'í˜¸ê¸°ì‹¬ ë§ê³  ì •ì§í•œ', avatar: 'ğŸ“°', desc: 'íƒì‚¬ë³´ë„ ì „ë¬¸ ê¸°ì' },
              { id: 'm16', name: 'ì •ì¬í›ˆ', job: 'ë””ìì´ë„ˆ', age: 28, personality: 'ì°½ì˜ì ì´ê³  íŠ¸ë Œë””í•œ', avatar: 'ğŸ¨', desc: 'UI/UX ë””ìì´ë„ˆ' },
              { id: 'm17', name: 'í•œìƒë¯¼', job: 'ê¸ˆìœµì „ë¬¸ê°€', age: 35, personality: 'ë¶„ì„ì ì´ê³  ì‹ ì¤‘í•œ', avatar: 'ğŸ’°', desc: 'íˆ¬ìì€í–‰ ì• ë„ë¦¬ìŠ¤íŠ¸' },
              { id: 'm18', name: 'ì†¡ì§€ì›', job: 'ê³¼í•™ì', age: 33, personality: 'ë…¼ë¦¬ì ì´ê³  íƒêµ¬ì ì¸', avatar: 'ğŸ”¬', desc: 'ìƒëª…ê³µí•™ ì—°êµ¬ì›' },
              { id: 'm19', name: 'ê¹€íƒœí˜„', job: 'êµ°ì¸', age: 31, personality: 'ê°•ì¸í•˜ê³  ì¶©ì„±ìŠ¤ëŸ¬ìš´', avatar: 'ğŸª–', desc: 'íŠ¹ìˆ˜ë¶€ëŒ€ ì¤‘ë ¹' },
              { id: 'm20', name: 'ì´í˜„ì¤€', job: 'ì‹¬ë¦¬ìƒë‹´ì‚¬', age: 34, personality: 'ê³µê°ëŠ¥ë ¥ì´ ë›°ì–´ë‚œ', avatar: 'ğŸ§ ', desc: 'ì„ìƒì‹¬ë¦¬ì „ë¬¸ê°€' },
              { id: 'm21', name: 'ë°•ë„ìœ¤', job: 'ë§ˆì¼€í„°', age: 29, personality: 'ì™¸í–¥ì ì´ê³  ì°½ì˜ì ì¸', avatar: 'ğŸ“Š', desc: 'ë””ì§€í„¸ ë§ˆì¼€íŒ… ì „ë¬¸ê°€' },
              { id: 'm22', name: 'ìµœìŠ¹ìš°', job: 'ì•½ì‚¬', age: 32, personality: 'ê¼¼ê¼¼í•˜ê³  ì¹œì ˆí•œ', avatar: 'ğŸ’Š', desc: 'ë³‘ì› ì•½ì‚¬' },
              { id: 'm23', name: 'ê°•í˜„ë¯¼', job: 'ë°°ìš°', age: 27, personality: 'ë§¤ë ¥ì ì´ê³  í‘œí˜„ë ¥ í’ë¶€í•œ', avatar: 'ğŸ­', desc: 'ì—°ê·¹ë°°ìš° ê²¸ ì˜í™”ë°°ìš°' },
              { id: 'm24', name: 'ìœ¤ì„±ì§„', job: 'ì»¨ì„¤í„´íŠ¸', age: 36, personality: 'ì „ëµì ì´ê³  ë…¼ë¦¬ì ì¸', avatar: 'ğŸ“‹', desc: 'ê²½ì˜ì»¨ì„¤í„´íŠ¸' },
              { id: 'm25', name: 'ì •ìš°ì„', job: 'ê²Œì„ê°œë°œì', age: 30, personality: 'ìƒìƒë ¥ í’ë¶€í•˜ê³  ì—´ì •ì ì¸', avatar: 'ğŸ®', desc: 'ì¸ë””ê²Œì„ ê°œë°œì' }
            ],
            female: [
              { id: 'f1', name: 'ê¹€ìˆ˜ì—°', job: 'ì˜ì‚¬', age: 30, personality: 'ë”°ëœ»í•˜ê³  ì „ë¬¸ì ì¸', avatar: 'ğŸ‘©â€âš•ï¸', desc: 'ì†Œì•„ê³¼ ì „ë¬¸ì˜' },
              { id: 'f2', name: 'ë°•ì§€ë¯¼', job: 'ê°œë°œì', age: 27, personality: 'ë˜‘ë˜‘í•˜ê³  ì°½ì˜ì ì¸', avatar: 'ğŸ‘©â€ğŸ’»', desc: 'AI ì—°êµ¬ì›' },
              { id: 'f3', name: 'ì´ì„œìœ¤', job: 'ë³€í˜¸ì‚¬', age: 33, personality: 'ë‹¹ë‹¹í•˜ê³  ì§€ì ì¸', avatar: 'ğŸ‘©â€ğŸ’¼', desc: 'êµ­ì œë²• ì „ë¬¸ ë³€í˜¸ì‚¬' },
              { id: 'f4', name: 'ìµœì˜ˆì€', job: 'ìš”ë¦¬ì‚¬', age: 28, personality: 'ì°½ì˜ì ì´ê³  ë”°ëœ»í•œ', avatar: 'ğŸ‘©â€ğŸ³', desc: 'íŒŒí‹°ì‹œì—' },
              { id: 'f5', name: 'ê°•í•˜ëŠ˜', job: 'ê°„í˜¸ì‚¬', age: 26, personality: 'ì¹œì ˆí•˜ê³  ì„¸ì‹¬í•œ', avatar: 'ğŸ‘©â€âš•ï¸', desc: 'ì¤‘í™˜ìì‹¤ ê°„í˜¸ì‚¬' },
              { id: 'f6', name: 'ìœ¤ì±„ì˜', job: 'êµì‚¬', age: 29, personality: 'ì¸ë‚´ì‹¬ ë§ê³  ë‹¤ì •í•œ', avatar: 'ğŸ‘©â€ğŸ«', desc: 'ì´ˆë“±í•™êµ ì„ ìƒë‹˜' },
              { id: 'f7', name: 'ì •ë¯¼ì•„', job: 'ê²½ì°°ê´€', age: 31, personality: 'ì •ì˜ë¡­ê³  ìš©ê°í•œ', avatar: 'ğŸ‘®â€â™€ï¸', desc: 'ì‚¬ì´ë²„ìˆ˜ì‚¬ëŒ€ ê²½ìœ„' },
              { id: 'f8', name: 'í•œì†Œí¬', job: 'ìŠ¹ë¬´ì›', age: 28, personality: 'ìš°ì•„í•˜ê³  ì¹œê·¼í•œ', avatar: 'ğŸ‘©â€âœˆï¸', desc: 'êµ­ì œì„  ìŠ¹ë¬´ì›' },
              { id: 'f9', name: 'ì†¡ìœ ì§„', job: 'ê±´ì¶•ê°€', age: 32, personality: 'ì˜ˆìˆ ì ì´ê³  ì„¬ì„¸í•œ', avatar: 'ğŸ‘·â€â™€ï¸', desc: 'ì¸í…Œë¦¬ì–´ ë””ìì´ë„ˆ' },
              { id: 'f10', name: 'ê¹€ë‚˜ì˜', job: 'ìš´ë™ì„ ìˆ˜', age: 24, personality: 'í™œë°œí•˜ê³  ë„ì „ì ì¸', avatar: 'ğŸƒâ€â™€ï¸', desc: 'ë§ˆë¼í†¤ ì„ ìˆ˜' },
              { id: 'f11', name: 'ì´ë‹¤ì€', job: 'ìŒì•…ê°€', age: 25, personality: 'ê°ì„±ì ì´ê³  ì˜ˆìˆ ì ì¸', avatar: 'ğŸ¤', desc: 'ì‹±ì–´ì†¡ë¼ì´í„°' },
              { id: 'f12', name: 'ë°•ì†Œì˜', job: 'ì‚¬ì—…ê°€', age: 34, personality: 'ë¦¬ë”ì‹­ ìˆê³  í˜ì‹ ì ì¸', avatar: 'ğŸ’¼', desc: 'íŒ¨ì…˜ ë¸Œëœë“œ CEO' },
              { id: 'f13', name: 'ìµœë¯¸ë˜', job: 'ìˆ˜ì˜ì‚¬', age: 29, personality: 'ë™ë¬¼ì„ ì‚¬ë‘í•˜ëŠ” ë”°ëœ»í•œ', avatar: 'ğŸ‘©â€âš•ï¸', desc: 'ì•¼ìƒë™ë¬¼ ìˆ˜ì˜ì‚¬' },
              { id: 'f14', name: 'ê°•ì˜ˆë¦°', job: 'ì‚¬ì§„ì‘ê°€', age: 27, personality: 'ì˜ˆìˆ ì ì´ê³  ê°ì„±ì ì¸', avatar: 'ğŸ“¸', desc: 'ì›¨ë”© ì‚¬ì§„ì‘ê°€' },
              { id: 'f15', name: 'ìœ¤ì§€ìˆ˜', job: 'ê¸°ì', age: 30, personality: 'ë˜‘ë˜‘í•˜ê³  ì •ì˜ë¡œìš´', avatar: 'ğŸ“°', desc: 'ë°©ì†¡êµ­ ì•µì»¤' },
              { id: 'f16', name: 'ì •í•˜ìœ¤', job: 'ë””ìì´ë„ˆ', age: 26, personality: 'íŠ¸ë Œë””í•˜ê³  ì°½ì˜ì ì¸', avatar: 'ğŸ¨', desc: 'íŒ¨ì…˜ ë””ìì´ë„ˆ' },
              { id: 'f17', name: 'í•œìœ ë¦¬', job: 'ê¸ˆìœµì „ë¬¸ê°€', age: 32, personality: 'ë¶„ì„ì ì´ê³  ë˜‘ë˜‘í•œ', avatar: 'ğŸ’°', desc: 'í€ë“œë§¤ë‹ˆì €' },
              { id: 'f18', name: 'ì†¡ì•„ë¦„', job: 'ê³¼í•™ì', age: 31, personality: 'íƒêµ¬ì ì´ê³  ë…¼ë¦¬ì ì¸', avatar: 'ğŸ”¬', desc: 'í™˜ê²½ê³¼í•™ì' },
              { id: 'f19', name: 'ê¹€ì„œí˜„', job: 'í•­ê³µê´€ì œì‚¬', age: 28, personality: 'ì¹¨ì°©í•˜ê³  ì •í™•í•œ', avatar: 'ğŸ›©ï¸', desc: 'ê³µí•­ ê´€ì œíƒ‘ ê·¼ë¬´' },
              { id: 'f20', name: 'ì´ì±„ë¦°', job: 'ì‹¬ë¦¬ìƒë‹´ì‚¬', age: 33, personality: 'ê³µê°ëŠ¥ë ¥ì´ ë›°ì–´ë‚œ', avatar: 'ğŸ§ ', desc: 'ì²­ì†Œë…„ ìƒë‹´ì‚¬' },
              { id: 'f21', name: 'ë°•í˜œì§„', job: 'ë§ˆì¼€í„°', age: 28, personality: 'ì™¸í–¥ì ì´ê³  í™œë°œí•œ', avatar: 'ğŸ“Š', desc: 'ë¸Œëœë“œ ë§ˆì¼€í„°' },
              { id: 'f22', name: 'ìµœìœ¤ì„œ', job: 'ì•½ì‚¬', age: 30, personality: 'ê¼¼ê¼¼í•˜ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ”', avatar: 'ğŸ’Š', desc: 'í•œì˜ì› ì•½ì‚¬' },
              { id: 'f23', name: 'ê°•ë¯¼ì •', job: 'ë°°ìš°', age: 26, personality: 'ë§¤ë ¥ì ì´ê³  ê°ì„±ì ì¸', avatar: 'ğŸ­', desc: 'ë®¤ì§€ì»¬ ë°°ìš°' },
              { id: 'f24', name: 'ìœ¤ì„œì•„', job: 'ì»¨ì„¤í„´íŠ¸', age: 35, personality: 'ì „ëµì ì´ê³  ì¹´ë¦¬ìŠ¤ë§ˆ ìˆëŠ”', avatar: 'ğŸ“‹', desc: 'HR ì»¨ì„¤í„´íŠ¸' },
              { id: 'f25', name: 'ì •ì˜ˆë‚˜', job: 'ì½˜í…ì¸  í¬ë¦¬ì—ì´í„°', age: 25, personality: 'ì°½ì˜ì ì´ê³  íŠ¸ë Œë””í•œ', avatar: 'ğŸ“±', desc: 'ìœ íŠœë²„ ê²¸ ì¸í”Œë£¨ì–¸ì„œ' }
            ]
          };

          // ëª¨ë“  í˜ë¥´ì†Œë‚˜ë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í•©ì¹˜ê¸°
          const personas = [...persona.male, ...persona.female];

        function init() {
            setupEventListeners();
            setupSpeechRecognition();
            renderPersonas();
        }

        function setupEventListeners() {
            document.getElementById('backBtn').onclick = function() { showView('personas'); };
            document.getElementById('themeBtn').onclick = toggleTheme;
            document.getElementById('ttsBtn').onclick = toggleTTS;
            document.getElementById('qrBtn').onclick = showQRCode;
            document.getElementById('profileBtn').onclick = function() { showModal('profileModal'); };
            document.getElementById('sendBtn').onclick = function() { sendMessage(document.getElementById('messageInput').value); };
            document.getElementById('micBtn').onclick = toggleRecording;
            document.getElementById('messageInput').onkeypress = function(e) { 
                if (e.key === 'Enter') sendMessage(document.getElementById('messageInput').value); 
            };
            
            document.getElementById('cancelProfile').onclick = function() { hideModal('profileModal'); };
            document.getElementById('saveProfile').onclick = saveProfile;
            document.getElementById('closeQR').onclick = function() { hideModal('qrModal'); };
        }

        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'ko-KR';
                recognition.onresult = function(e) {
                    document.getElementById('messageInput').value = e.results[0][0].transcript;
                    setRecording(false);
                };
                recognition.onerror = function() { setRecording(false); };
            }
        }

        function renderPersonas() {
            var html = '';
            for (var i = 0; i < personas.length; i++) {
                var p = personas[i];
                html += '<div class="persona-card" onclick="selectPersona(\'' + p.id + '\')">';
                html += '<div style="font-size: 2rem; margin-bottom: 0.5rem;">' + p.avatar + '</div>';
                html += '<h3>' + p.name + '</h3>';
                html += '<p style="color: #8b5cf6; font-size: 0.9rem;">' + p.job + ' â€¢ ' + p.age + 'ì„¸</p>';
                html += '<p style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.8;">' + p.desc + '</p>';
                html += '</div>';
            }
            document.getElementById('personasGrid').innerHTML = html;
        }

        function selectPersona(id) {
            

            for (var i = 0; i < personas.length; i++) {
                if (personas[i].id === id) {
                    selectedPersona = personas[i];
                    break;
                }
            }
            messages = [{
                type: 'bot',
                content: 'ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ' + selectedPersona.name + 'ì´ì—ìš”. ' + selectedPersona.desc + 'ì…ë‹ˆë‹¤. ë°˜ê°€ì›Œìš”! ğŸ˜Š',
                timestamp: new Date()
            }];
            showView('chat');
            renderMessages();
            speakText(messages[0].content, id);
        }

        function showView(view) {
            currentView = view;
            if (view === 'personas') {
                document.getElementById('profileBtn').classList.remove('hidden');
                document.getElementById('personasView').classList.remove('hidden');
                document.getElementById('chatView').classList.add('hidden');
                document.getElementById('backBtn').classList.add('hidden');
                document.getElementById('ttsBtn').classList.add('hidden');
                document.getElementById('qrBtn').classList.add('hidden');
                document.getElementById('title').textContent = 'AI í˜ë¥´ì†Œë‚˜';
            } else {
                document.getElementById('profileBtn').classList.add('hidden');
                document.getElementById('personasView').classList.add('hidden');
                document.getElementById('chatView').classList.remove('hidden');
                document.getElementById('backBtn').classList.remove('hidden');
                document.getElementById('ttsBtn').classList.remove('hidden');
                document.getElementById('qrBtn').classList.remove('hidden');
                document.getElementById('title').textContent = selectedPersona.avatar + " " + selectedPersona.name;
            }
        }

        function sendMessage(text) {
            if (!text.trim() || !selectedPersona) return;
            
            var userMessage = { type: 'user', content: text, timestamp: new Date() };
            messages.push(userMessage);
            document.getElementById('messageInput').value = '';
            renderMessages();
            showTyping();

            console.log(prompt,history.slice(-10))

            fetch('http://192.168.3.73:59531/v2/txt2chat?isThink=0', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: text,
                    history : history.slice(-4),
                    lang: "auto",
                    type: 'ë‹¹ì‹ ì€ ' + selectedPersona.name + 'ì´ë¼ëŠ” ' + selectedPersona.age + 'ì‚´ ' + selectedPersona.job + 'ì…ë‹ˆë‹¤. ' + selectedPersona.desc + 'ì…ë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ' + (userProfile.name || 'ì¹œêµ¬') + 'ë¼ëŠ” ' + (userProfile.age || '20ëŒ€') + ' ' + (userProfile.gender || 'ì‚¬ëŒ') + 'ì´ê³ , ' + (userProfile.interests || 'ë‹¤ì–‘í•œ ê²ƒë“¤') + 'ì— ê´€ì‹¬ì´ ìˆìŠµë‹ˆë‹¤. ìì—°ìŠ¤ëŸ½ê³  ê°ì •ì ì¸ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ë©°, ì´ëª¨í‹°ì½˜ë„ ì ì ˆíˆ ì‚¬ìš©í•´ì£¼ì„¸ìš”.',
                    //temp: 0.6, top_p: 0.95, top_k: 20, max: 32768
                })
            }).then(function(response) {
                return response.body.getReader();
            }).then(function(reader) {
                var decoder = new TextDecoder();
                var botResponse = '';
                
                hideTyping();
                var botMessage = { type: 'bot', content: '', timestamp: new Date() };
                messages.push(botMessage);

                function readStream() {
                    return reader.read().then(function(result) {
                        if (result.done) {
                            history.push({ role: 'user', content: text })
                            history.push({ role: 'assistant', content: botResponse })
                            speakText(botResponse);
                            return;
                        }
                        botResponse += decoder.decode(result.value);
                        messages[messages.length - 1].content = botResponse;
                        renderMessages();
                        return readStream();
                    });
                }
                return readStream();
            }).catch(function(error) {
                hideTyping();
                messages.push({ type: 'bot', content: 'ì£„ì†¡í•´ìš”, ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ğŸ˜…', timestamp: new Date() });
                renderMessages();
            });
        }

        function renderMessages() {
            var html = '';
            for (var i = 0; i < messages.length; i++) {
                var m = messages[i];
                html += '<div class="message ' + m.type + '">';
                html += '<div class="message-content">';
                html += marked.parse(m.content.replace(/\n/gi, "</br>"));
                html += '<div style="font-size: 0.7rem; opacity: 0.7; margin-top: 0.25rem;">';
                html += m.timestamp.toLocaleTimeString();
                html += '</div></div></div>';
            }
            document.getElementById('messages').innerHTML = html;
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function showTyping() {
            var typing = document.createElement('div');
            typing.id = 'typing';
            typing.className = 'message bot';
            typing.innerHTML = '<div class="message-content"><div class="typing"><div></div><div></div><div></div></div></div>';
            document.getElementById('messages').appendChild(typing);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function hideTyping() {
            var typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        let userId = 0

        function speakText(text, id=0) {
            if(id) 
                userId = id
            

            if (!isTTSEnabled) return;
            //var utterance = new SpeechSynthesisUtterance(text.replace(/[.!?]/g, ''));
            //utterance.lang = 'ko-KR';
            //speechSynthesis.speak(utterance);

            let voice = 0 

            if(userId.startsWith('m'))
                voice = userId.replace('m','man')
            else if(userId.startsWith('f')) 
                voice = userId.replace('f','woman')
            
            if(audio && !audio.paused) {
                audio.pause();
                audio.currentTime = 0;
            }

            audio = new Audio(`https://oe-sapi.circul.us/tts?text=${encodeURIComponent(text.replace(/[.!?]/g, ''))}&lang=ko&voice=${voice}`);
            audio.play().catch(function(error) {
                console.error('TTS ì˜¤ë¥˜:', error);
            });
        }

        function toggleTTS() {
            isTTSEnabled = !isTTSEnabled;
            document.getElementById('ttsBtn').textContent = isTTSEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
        }

        function toggleRecording() {
            if (!recognition) return;
            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
            }
            setRecording(!isRecording);
        }

        function setRecording(recording) {
            isRecording = recording;
            document.getElementById('micBtn').className = recording ? 'btn recording' : 'btn';
            document.getElementById('micBtn').textContent = recording ? 'ğŸ›‘' : 'ğŸ¤';
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.className = isDarkTheme ? 'dark' : 'light';
            document.getElementById('themeBtn').textContent = isDarkTheme ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function saveProfile() {
            userProfile = {
                name: document.getElementById('nameInput').value,
                age: document.getElementById('ageInput').value,
                gender: document.getElementById('genderInput').value,
                interests: document.getElementById('interestsInput').value
            };
            hideModal('profileModal');
        }

        function showQRCode() {
            if (!selectedPersona) return;
            var url = window.location.origin + '?persona=' + selectedPersona.id;
            document.getElementById('qrTitle').textContent = selectedPersona.name + ' ê³µìœ í•˜ê¸°';
            document.getElementById('qrImage').src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(url);
            showModal('qrModal');
        }

        init();
    </script>
</body>
</html>