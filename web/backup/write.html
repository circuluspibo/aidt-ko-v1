<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>한글 쓰기 연습 - 특수 아동 한글 교육</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            font-size: 20px;
            color: #1e293b;
            overflow: hidden;
            touch-action: manipulation;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 3fr;
            height: 100vh;
            gap: 25px;
            padding: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .ai-tutor-sidebar {
            background: white;
            border-radius: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            border: 4px solid #3b82f6;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 320px;
        }

        .tutor-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .tutor-avatar {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            border: 4px solid #60a5fa;
            animation: gentle-bounce 3s ease-in-out infinite;
        }

        @keyframes gentle-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .tutor-name {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .tutor-status {
            font-size: 14px;
            opacity: 0.9;
        }

        .tutor-body {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .tutor-message {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
            font-size: 16px;
            line-height: 1.5;
            min-height: 120px;
            display: flex;
            align-items: center;
        }

        /* 토글 제어 영역 */
        .toggle-section {
            background: #f8fafc;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
            margin-bottom: 15px;
        }

        .toggle-header {
            padding: 12px 15px;
            background: #e2e8f0;
            border-radius: 13px 13px 0 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
        }

        .toggle-content {
            padding: 15px;
            display: none;
        }

        .toggle-content.show {
            display: block;
        }

        .toggle-arrow {
            transition: transform 0.3s ease;
        }

        .toggle-arrow.rotate {
            transform: rotate(180deg);
        }

        /* 학습 레벨 선택 */
        .level-title {
            font-size: 16px;
            font-weight: bold;
            color: #374151;
            margin-bottom: 10px;
        }

        .level-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .level-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: white;
            border: 2px solid #d1d5db;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .level-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        /* 반복 설정 영역 */
        .setting-group {
            margin-bottom: 12px;
        }

        .setting-label {
            font-size: 14px;
            font-weight: bold;
            color: #374151;
            margin-bottom: 6px;
            display: block;
        }

        .setting-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .repeat-counter {
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 16px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }

        .adjust-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 8px;
            background: #3b82f6;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
        }

        /* 데이터 표시 영역 */
        .data-display {
            background: #f1f5f9;
            border-radius: 10px;
            padding: 10px;
            font-size: 12px;
            color: #64748b;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .tutor-controls {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .tutor-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: #3b82f6;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.2s ease;
        }

        .tutor-btn:active {
            transform: scale(0.95);
            background: #2563eb;
        }

        /* 메인 학습 영역 */
        .main-learning-area {
            background: white;
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            border: 3px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .learning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 20px;
            color: white;
        }

        .lesson-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .lesson-title {
            font-size: 24px;
            font-weight: bold;
        }

        .lesson-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar {
            width: 150px;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .repeat-status {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        /* 쓰기 연습 영역 */
        .writing-area {
            flex: 1;
            background: #f8fafc;
            border-radius: 20px;
            padding: 30px;
            border: 2px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 500px;
        }

        .letter-display-section {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            align-items: center;
        }

        .target-letter {
            font-size: 120px;
            font-weight: bold;
            color: #1e293b;
            background: white;
            padding: 40px;
            border-radius: 25px;
            border: 4px solid #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 200px;
            min-height: 200px;
            position: relative;
        }

        .hint-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .hint-image {
            width: 120px;
            height: 120px;
            background: #f0f9ff;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            border: 3px solid #3b82f6;
            align-self: center;
        }

        .hint-text {
            background: white;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #374151;
        }

        .writing-canvas-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            border: 3px solid #d1d5db;
            margin-bottom: 30px;
        }

        .canvas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .canvas-title {
            font-size: 18px;
            font-weight: bold;
            color: #374151;
        }

        .canvas-controls {
            display: flex;
            gap: 10px;
        }

        .canvas-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .canvas-btn.clear {
            background: #ef4444;
            color: white;
        }

        .canvas-btn.guide {
            background: #10b981;
            color: white;
        }

        .canvas-container {
            position: relative;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
        }

        #writingCanvas {
            display: block;
            cursor: crosshair;
            background: #fafafa;
        }

        .guide-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            opacity: 0.3;
            font-size: 300px;
            font-weight: bold;
            color: #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .practice-choices {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .choice-btn {
            padding: 20px;
            border: none;
            border-radius: 15px;
            background: white;
            border: 3px solid #d1d5db;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .choice-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateY(-2px);
        }

        .choice-btn.correct {
            background: #dcfce7;
            border-color: #22c55e;
            animation: correctPulse 0.8s ease;
        }

        .choice-btn.incorrect {
            background: #fef2f2;
            border-color: #ef4444;
            animation: shake 0.6s ease;
        }

        /* 애니메이션 */
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: #bbf7d0; }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* 하단 액션 버튼들 */
        .action-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .action-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.3s ease;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .action-btn.next {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        /* 피드백 오버레이 */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .feedback-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .feedback-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .feedback-text {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .feedback-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            background: #3b82f6;
            color: white;
        }

        /* 반응형 디자인 */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr 2fr;
                gap: 20px;
                padding: 20px;
            }
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                gap: 15px;
                padding: 15px;
            }
            
            .ai-tutor-sidebar {
                max-height: 400px;
                min-width: auto;
            }
            
            .practice-choices {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .letter-display-section {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- AI 튜터 사이드바 -->
        <div class="ai-tutor-sidebar">
            <div class="tutor-header">
                <div class="tutor-avatar">✏️</div>
                <div class="tutor-name">쓰기 선생님</div>
                <div class="tutor-status">함께 써봐요!</div>
            </div>
            <div class="tutor-body">
                <div class="tutor-message" id="tutorMessage">
                    안녕하세요! 오늘은 한글 쓰기를 연습해봐요. 
                    캔버스에 직접 써보고, 문제도 풀어보세요! ✏️✨
                </div>
                
                <!-- 학습 단계 선택 (토글) -->
                <div class="toggle-section">
                    <div class="toggle-header" onclick="toggleSection('levelSection')">
                        <span>📚 학습 단계 선택</span>
                        <span class="toggle-arrow" id="levelArrow">▼</span>
                    </div>
                    <div class="toggle-content" id="levelSection">
                        <div class="level-buttons">
                            <button class="level-btn active" onclick="selectLevel('consonant')">1단계: 자음 쓰기</button>
                            <button class="level-btn" onclick="selectLevel('vowel')">2단계: 모음 쓰기</button>
                            <button class="level-btn" onclick="selectLevel('combination')">3단계: 글자 쓰기</button>
                            <button class="level-btn" onclick="selectLevel('word')">4단계: 단어 쓰기</button>
                        </div>
                    </div>
                </div>
                
                <!-- 반복 설정 (토글) -->
                <div class="toggle-section">
                    <div class="toggle-header" onclick="toggleSection('repeatSection')">
                        <span>🔄 반복 설정</span>
                        <span class="toggle-arrow" id="repeatArrow">▼</span>
                    </div>
                    <div class="toggle-content" id="repeatSection">
                        <div class="setting-group">
                            <label class="setting-label">맞췄을 때 반복</label>
                            <div class="setting-controls">
                                <button class="adjust-btn" onclick="adjustRepeat('correct', -1)">-</button>
                                <div class="repeat-counter" id="correctRepeat">3</div>
                                <button class="adjust-btn" onclick="adjustRepeat('correct', 1)">+</button>
                            </div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">틀렸을 때 반복</label>
                            <div class="setting-controls">
                                <button class="adjust-btn" onclick="adjustRepeat('incorrect', -1)">-</button>
                                <div class="repeat-counter" id="incorrectRepeat">5</div>
                                <button class="adjust-btn" onclick="adjustRepeat('incorrect', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 학습 데이터 표시 (토글) -->
                <div class="toggle-section">
                    <div class="toggle-header" onclick="toggleSection('dataSection')">
                        <span>📊 학습 데이터</span>
                        <span class="toggle-arrow" id="dataArrow">▼</span>
                    </div>
                    <div class="toggle-content" id="dataSection">
                        <div class="data-display" id="learningData">
                            <div class="data-row">
                                <span>정답률:</span>
                                <span id="accuracyRate">0%</span>
                            </div>
                            <div class="data-row">
                                <span>총 문제:</span>
                                <span id="totalProblems">0</span>
                            </div>
                            <div class="data-row">
                                <span>맞춘 문제:</span>
                                <span id="correctProblems">0</span>
                            </div>
                            <div class="data-row">
                                <span>평균 시간:</span>
                                <span id="avgTime">0초</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tutor-controls">
                    <button class="tutor-btn" onclick="getTutorHelp()">💡 도움말</button>
                    <button class="tutor-btn" onclick="clearCanvas()">🗑️ 지우기</button>
                </div>
            </div>
        </div>

        <!-- 메인 학습 영역 -->
        <div class="main-learning-area">
            <!-- 상단 헤더 -->
            <div class="learning-header">
                <div class="lesson-info">
                    <div class="lesson-title" id="lessonTitle">자음 쓰기 연습</div>
                    <div class="lesson-subtitle" id="lessonSubtitle">기초 자음 'ㄱ' 쓰기 연습</div>
                </div>
                <div class="progress-info">
                    <div class="repeat-status" id="repeatStatus">반복: 1/3</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 10%"></div>
                    </div>
                </div>
            </div>

            <!-- 쓰기 연습 영역 -->
            <div class="writing-area">
                <!-- 글자 표시 및 힌트 -->
                <div class="letter-display-section">
                    <div class="target-letter" id="targetLetter">ㄱ</div>
                    <div class="hint-section">
                        <div class="hint-image" id="hintImage">🐱</div>
                        <div class="hint-text" id="hintText">고양이의 'ㄱ'</div>
                    </div>
                </div>

                <!-- 쓰기 캔버스 -->
                <div class="writing-canvas-section">
                    <div class="canvas-header">
                        <div class="canvas-title">✏️ 직접 써보세요!</div>
                        <div class="canvas-controls">
                            <button class="canvas-btn guide" onclick="toggleGuide()">가이드</button>
                            <button class="canvas-btn clear" onclick="clearCanvas()">지우기</button>
                        </div>
                    </div>
                    <div class="canvas-container">
                        <canvas id="writingCanvas" width="600" height="300"></canvas>
                        <div class="guide-overlay" id="guideOverlay" style="display: none;">ㄱ</div>
                    </div>
                </div>

                <!-- 문제 선택지 -->
                <p style="font-size: 20px; margin-bottom: 20px; font-weight: bold; text-align: center;">
                    "<span id="targetChoice">ㄱ</span>"을 찾아보세요!
                </p>
                
                <div class="practice-choices" id="practiceChoices">
                    <!-- 동적으로 생성됨 -->
                </div>
            </div>

            <!-- 하단 액션 버튼들 -->
            <div class="action-controls">
                <button class="action-btn primary" onclick="markActivity(true)">✅ 잘했어요!</button>
                <button class="action-btn secondary" onclick="markActivity(false)">❌ 다시해요</button>
                <button class="action-btn next" onclick="nextItem()">➡️ 다음 학습</button>
            </div>
        </div>
    </div>

    <!-- 피드백 오버레이 -->
    <div class="feedback-overlay" id="feedbackOverlay">
        <div class="feedback-content">
            <div class="feedback-icon" id="feedbackIcon">🎉</div>
            <div class="feedback-text" id="feedbackText">정말 잘했어요!</div>
            <button class="feedback-btn" onclick="closeFeedback()">계속하기</button>
        </div>
    </div>

    <script>
        // 전역 상태 관리
        let currentLevel = 'consonant';
        let currentItemIndex = 0;
        let currentRepeat = 1;
        let startTime = null;
        let guideVisible = false;
        let isDrawing = false;
        
        // 반복 설정
        let repeatSettings = {
            correct: 3,
            incorrect: 5
        };
        
        // 학습 데이터 수집
        let learningStats = {
            totalProblems: 0,
            correctProblems: 0,
            responseTimes: [],
            problemLog: []
        };
        
        // 학습 데이터베이스 (힌트 이미지 포함)
        const learningData = {
            consonant: [
                { letter: 'ㄱ', name: '기역', sound: '[ㄱ]', example: '고양이의 ㄱ', image: '🐱' },
                { letter: 'ㄴ', name: '니은', sound: '[ㄴ]', example: '나비의 ㄴ', image: '🦋' },
                { letter: 'ㄷ', name: '디귿', sound: '[ㄷ]', example: '다람쥐의 ㄷ', image: '🐿️' },
                { letter: 'ㄹ', name: '리을', sound: '[ㄹ]', example: '라면의 ㄹ', image: '🍜' },
                { letter: 'ㅁ', name: '미음', sound: '[ㅁ]', example: '모자의 ㅁ', image: '👒' },
                { letter: 'ㅂ', name: '비읍', sound: '[ㅂ]', example: '바나나의 ㅂ', image: '🍌' },
                { letter: 'ㅅ', name: '시옷', sound: '[ㅅ]', example: '사과의 ㅅ', image: '🍎' },
                { letter: 'ㅇ', name: '이응', sound: '[ㅇ]', example: '아기의 ㅇ', image: '👶' },
                { letter: 'ㅈ', name: '지읒', sound: '[ㅈ]', example: '자동차의 ㅈ', image: '🚗' },
                { letter: 'ㅊ', name: '치읓', sound: '[ㅊ]', example: '치킨의 ㅊ', image: '🍗' }
            ],
            vowel: [
                { letter: 'ㅏ', name: '아', sound: '[아]', example: '아기의 ㅏ', image: '👶' },
                { letter: 'ㅑ', name: '야', sound: '[야]', example: '야구의 ㅑ', image: '⚾' },
                { letter: 'ㅓ', name: '어', sound: '[어]', example: '어머니의 ㅓ', image: '👩' },
                { letter: 'ㅕ', name: '여', sound: '[여]', example: '여우의 ㅕ', image: '🦊' },
                { letter: 'ㅗ', name: '오', sound: '[오]', example: '오리의 ㅗ', image: '🦆' },
                { letter: 'ㅛ', name: '요', sound: '[요]', example: '요구르트의 ㅛ', image: '🥛' },
                { letter: 'ㅜ', name: '우', sound: '[우]', example: '우유의 ㅜ', image: '🥛' },
                { letter: 'ㅠ', name: '유', sound: '[유]', example: '유리의 ㅠ', image: '🥃' },
                { letter: 'ㅡ', name: '으', sound: '[으]', example: '으음의 ㅡ', image: '🤔' },
                { letter: 'ㅣ', name: '이', sound: '[이]', example: '이빨의 ㅣ', image: '🦷' }
            ],
            combination: [
                { consonant: 'ㄱ', vowel: 'ㅏ', result: '가', meaning: '가방의 가', image: '🎒' },
                { consonant: 'ㄴ', vowel: 'ㅏ', result: '나', meaning: '나비의 나', image: '🦋' },
                { consonant: 'ㄷ', vowel: 'ㅏ', result: '다', meaning: '다람쥐의 다', image: '🐿️' },
                { consonant: 'ㄹ', vowel: 'ㅏ', result: '라', meaning: '라면의 라', image: '🍜' },
                { consonant: 'ㅁ', vowel: 'ㅏ', result: '마', meaning: '마음의 마', image: '❤️' },
                { consonant: 'ㅂ', vowel: 'ㅏ', result: '바', meaning: '바나나의 바', image: '🍌' },
                { consonant: 'ㅅ', vowel: 'ㅏ', result: '사', meaning: '사과의 사', image: '🍎' },
                { consonant: 'ㅇ', vowel: 'ㅏ', result: '아', meaning: '아기의 아', image: '👶' },
                { consonant: 'ㅈ', vowel: 'ㅏ', result: '자', meaning: '자동차의 자', image: '🚗' },
                { consonant: 'ㅊ', vowel: 'ㅏ', result: '차', meaning: '차의 차', image: '🚗' }
            ],
            word: [
                { word: '가방', syllables: ['가', '방'], image: '🎒', meaning: '책을 넣는 것' },
                { word: '나비', syllables: ['나', '비'], image: '🦋', meaning: '예쁜 날개가 있는 곤충' },
                { word: '다리', syllables: ['다', '리'], image: '🦵', meaning: '걸을 때 사용하는 몸의 부분' },
                { word: '라면', syllables: ['라', '면'], image: '🍜', meaning: '맛있는 면 요리' },
                { word: '마음', syllables: ['마', '음'], image: '❤️', meaning: '사랑하는 기분' },
                { word: '바다', syllables: ['바', '다'], image: '🌊', meaning: '넓고 푸른 물' },
                { word: '사과', syllables: ['사', '과'], image: '🍎', meaning: '빨간 과일' },
                { word: '아기', syllables: ['아', '기'], image: '👶', meaning: '작고 귀여운 사람' }
            ]
        };
        
        // 캔버스 초기화
        let canvas, ctx;
        
        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('writingCanvas');
            ctx = canvas.getContext('2d');
            
            // 캔버스 설정
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // 터치 및 마우스 이벤트 등록
            setupCanvasEvents();
            
            // 초기 데이터 로드
            selectLevel('consonant');
            updateLearningData();
            
            setTimeout(() => {
                updateTutorMessage('👋 환영해요!', 
                    '한글 쓰기 연습을 시작해봐요! 캔버스에 직접 써보고 문제도 풀어보세요! ✏️✨');
            }, 1000);
        });
        
        // 캔버스 이벤트 설정
        function setupCanvasEvents() {
            // 마우스 이벤트
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // 터치 이벤트
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }
        
        // 그리기 시작
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        
        // 그리기
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        
        // 그리기 중지
        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }
        
        // 터치 이벤트 처리
        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        // 캔버스 지우기
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        // 가이드 토글
        function toggleGuide() {
            guideVisible = !guideVisible;
            const guideOverlay = document.getElementById('guideOverlay');
            guideOverlay.style.display = guideVisible ? 'flex' : 'none';
            
            if (guideVisible) {
                const currentData = learningData[currentLevel][currentItemIndex];
                if (currentLevel === 'combination') {
                    guideOverlay.textContent = currentData.result;
                } else if (currentLevel === 'word') {
                    guideOverlay.textContent = currentData.word;
                } else {
                    guideOverlay.textContent = currentData.letter;
                }
            }
        }
        
        // 토글 섹션 제어
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const arrow = document.getElementById(sectionId.replace('Section', 'Arrow'));
            
            if (section.classList.contains('show')) {
                section.classList.remove('show');
                arrow.classList.remove('rotate');
            } else {
                section.classList.add('show');
                arrow.classList.add('rotate');
            }
        }
        
        // 레벨 선택
        function selectLevel(level) {
            // 레벨 버튼 상태 업데이트
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentLevel = level;
            currentItemIndex = 0;
            currentRepeat = 1;
            
            updateContent();
            updateLevelMessage();
            generateRandomChoices();
            clearCanvas();
        }
        
        // 레벨별 메시지 업데이트
        function updateLevelMessage() {
            const currentData = learningData[currentLevel][currentItemIndex];
            const messages = {
                consonant: {
                    title: '자음 쓰기 연습',
                    subtitle: `기초 자음 '${currentData.letter}' 쓰기 연습`,
                    message: `자음 '${currentData.letter}'을 캔버스에 써보고 문제도 풀어보세요! ${currentData.example} 📚`
                },
                vowel: {
                    title: '모음 쓰기 연습', 
                    subtitle: `기초 모음 '${currentData.letter}' 쓰기 연습`,
                    message: `모음 '${currentData.letter}'을 캔버스에 써보고 문제도 풀어보세요! ${currentData.example} 🎵`
                },
                combination: {
                    title: '글자 쓰기 연습',
                    subtitle: `'${currentData.result}' 글자 쓰기 연습`,
                    message: `'${currentData.result}' 글자를 캔버스에 써보고 문제도 풀어보세요! ${currentData.meaning} ✨`
                },
                word: {
                    title: '단어 쓰기 연습',
                    subtitle: `'${currentData.word}' 단어 쓰기 연습`,
                    message: `'${currentData.word}' 단어를 캔버스에 써보고 문제도 풀어보세요! ${currentData.meaning} 🏆`
                }
            };
            
            const levelInfo = messages[currentLevel];
            document.getElementById('lessonTitle').textContent = levelInfo.title;
            document.getElementById('lessonSubtitle').textContent = levelInfo.subtitle;
            updateTutorMessage(levelInfo.title, levelInfo.message);
        }
        
        // 콘텐츠 업데이트
        function updateContent() {
            const currentData = learningData[currentLevel][currentItemIndex];
            
            // 타겟 글자 업데이트
            let targetText, hintText;
            
            switch(currentLevel) {
                case 'consonant':
                case 'vowel':
                    targetText = currentData.letter;
                    hintText = currentData.example;
                    break;
                case 'combination':
                    targetText = currentData.result;
                    hintText = currentData.meaning;
                    break;
                case 'word':
                    targetText = currentData.word;
                    hintText = currentData.meaning;
                    break;
            }
            
            document.getElementById('targetLetter').textContent = targetText;
            document.getElementById('targetChoice').textContent = targetText;
            document.getElementById('hintText').textContent = hintText;
            document.getElementById('hintImage').textContent = currentData.image;
            
            // 가이드 오버레이 업데이트
            if (guideVisible) {
                document.getElementById('guideOverlay').textContent = targetText;
            }
            
            updateProgressBar();
            updateRepeatStatus();
        }
        
        // 랜덤 선택지 생성
        function generateRandomChoices() {
            const container = document.getElementById('practiceChoices');
            const currentData = learningData[currentLevel];
            const currentItem = currentData[currentItemIndex];
            
            // 정답 결정
            let correctAnswer;
            switch(currentLevel) {
                case 'consonant':
                case 'vowel':
                    correctAnswer = currentItem.letter;
                    break;
                case 'combination':
                    correctAnswer = currentItem.result;
                    break;
                case 'word':
                    correctAnswer = currentItem.word;
                    break;
            }
            
            // 오답 선택지 생성 (3개)
            let wrongAnswers = [];
            const allItems = [...currentData];
            allItems.splice(currentItemIndex, 1); // 현재 항목 제거
            
            // 랜덤하게 3개 선택
            const shuffled = allItems.sort(() => Math.random() - 0.5);
            wrongAnswers = shuffled.slice(0, 3).map(item => {
                switch(currentLevel) {
                    case 'consonant':
                    case 'vowel':
                        return item.letter;
                    case 'combination':
                        return item.result;
                    case 'word':
                        return item.word;
                    default:
                        return item.letter;
                }
            });
            
            // 전체 선택지 (정답 + 오답 3개) 랜덤 배치
            const allChoices = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5);
            
            container.innerHTML = '';
            
            allChoices.forEach(choice => {
                const choiceBtn = document.createElement('button');
                choiceBtn.className = 'choice-btn';
                choiceBtn.textContent = choice;
                choiceBtn.onclick = () => selectChoice(choice, correctAnswer);
                container.appendChild(choiceBtn);
            });
            
            // 문제 시작 시간 기록
            startTime = Date.now();
        }
        
        // 선택 처리
        function selectChoice(selectedChoice, correctAnswer) {
            const isCorrect = selectedChoice === correctAnswer;
            const responseTime = Date.now() - startTime;
            const buttons = document.querySelectorAll('.choice-btn');
            
            // 모든 버튼 비활성화
            buttons.forEach(btn => {
                btn.style.pointerEvents = 'none';
                btn.classList.remove('correct', 'incorrect');
            });
            
            // 선택된 버튼에 피드백 적용
            const selectedButton = Array.from(buttons).find(btn => 
                btn.textContent === selectedChoice
            );
            
            if (selectedButton) {
                selectedButton.classList.add(isCorrect ? 'correct' : 'incorrect');
            }
            
            // 학습 데이터 기록
            learningStats.totalProblems++;
            if (isCorrect) {
                learningStats.correctProblems++;
            }
            learningStats.responseTimes.push(responseTime);
            learningStats.problemLog.push({
                level: currentLevel,
                item: currentItemIndex,
                question: correctAnswer,
                answer: selectedChoice,
                isCorrect: isCorrect,
                responseTime: responseTime,
                timestamp: new Date().toISOString()
            });
            
            updateLearningData();
            
            if (isCorrect) {
                updateTutorMessage('🎉 정답이에요!', 
                    `"${selectedChoice}"를 정확히 찾았네요! 정말 잘했어요! 👏`);
                setTimeout(() => {
                    markActivity(true);
                    resetChoices();
                }, 1500);
            } else {
                updateTutorMessage('😊 다시 생각해보세요!', 
                    `조금 다른 것 같아요. 정답은 "${correctAnswer}"이에요! 💡`);
                setTimeout(() => {
                    resetChoices();
                }, 2000);
            }
        }
        
        // 선택지 리셋
        function resetChoices() {
            const buttons = document.querySelectorAll('.choice-btn');
            buttons.forEach(btn => {
                btn.classList.remove('correct', 'incorrect');
                btn.style.pointerEvents = 'auto';
            });
            
            // 새로운 랜덤 선택지 생성
            generateRandomChoices();
        }
        
        // 진행률 업데이트
        function updateProgressBar() {
            const totalItems = learningData[currentLevel].length;
            const progress = ((currentItemIndex + (currentRepeat - 1) / repeatSettings.correct) / totalItems) * 100;
            document.getElementById('progressFill').style.width = Math.min(progress, 100) + '%';
        }
        
        // 반복 상태 업데이트
        function updateRepeatStatus() {
            const maxRepeat = repeatSettings.correct;
            document.getElementById('repeatStatus').textContent = `반복: ${currentRepeat}/${maxRepeat}`;
        }
        
        // 학습 데이터 업데이트
        function updateLearningData() {
            const accuracyRate = learningStats.totalProblems > 0 ? 
                Math.round((learningStats.correctProblems / learningStats.totalProblems) * 100) : 0;
            
            const avgTime = learningStats.responseTimes.length > 0 ?
                Math.round(learningStats.responseTimes.reduce((a, b) => a + b, 0) / learningStats.responseTimes.length / 1000) : 0;
            
            document.getElementById('accuracyRate').textContent = accuracyRate + '%';
            document.getElementById('totalProblems').textContent = learningStats.totalProblems;
            document.getElementById('correctProblems').textContent = learningStats.correctProblems;
            document.getElementById('avgTime').textContent = avgTime + '초';
        }
        
        // 반복 회수 조정
        function adjustRepeat(type, delta) {
            const newValue = repeatSettings[type] + delta;
            if (newValue >= 1 && newValue <= 10) {
                repeatSettings[type] = newValue;
                document.getElementById(type + 'Repeat').textContent = newValue;
                
                updateTutorMessage('설정 변경', 
                    `${type === 'correct' ? '맞췄을 때' : '틀렸을 때'} 반복 횟수가 ${newValue}회로 설정되었어요! 👍`);
                
                updateProgressBar();
                updateRepeatStatus();
            }
        }
        
        // 활동 평가
        function markActivity(isCorrect) {
            if (isCorrect) {
                if (currentRepeat < repeatSettings.correct) {
                    currentRepeat++;
                    updateRepeatStatus();
                    updateProgressBar();
                    showFeedback(true, false);
                } else {
                    showFeedback(true, true);
                    setTimeout(() => nextItem(), 2000);
                }
            } else {
                currentRepeat = Math.min(currentRepeat + 1, repeatSettings.incorrect);
                updateRepeatStatus();
                showFeedback(false, false);
            }
        }
        
        // 다음 항목
        function nextItem() {
            const maxIndex = learningData[currentLevel].length - 1;
            
            if (currentItemIndex < maxIndex) {
                currentItemIndex++;
                currentRepeat = 1;
                updateContent();
                updateLevelMessage();
                generateRandomChoices();
                clearCanvas();
            } else {
                showLevelComplete();
            }
        }
        
        // 레벨 완료 표시
        function showLevelComplete() {
            const levelNames = {
                consonant: '자음 쓰기',
                vowel: '모음 쓰기',
                combination: '글자 쓰기',
                word: '단어 쓰기'
            };
            
            updateTutorMessage('🏆 레벨 완료!', 
                `${levelNames[currentLevel]} 단계를 모두 완료했어요! 정말 대단해요! 다른 단계도 도전해보세요! 🎉`);
        }
        
        // 피드백 표시
        function showFeedback(isCorrect, isComplete) {
            const overlay = document.getElementById('feedbackOverlay');
            const icon = document.getElementById('feedbackIcon');
            const text = document.getElementById('feedbackText');
            
            if (isCorrect) {
                if (isComplete) {
                    icon.textContent = '🏆';
                    text.textContent = '이 글자를 완벽하게 배웠어요!';
                } else {
                    icon.textContent = '✨';
                    text.textContent = '잘했어요! 한 번 더 해봐요!';
                }
            } else {
                icon.textContent = '💪';
                text.textContent = '괜찮아요! 다시 도전해봐요!';
            }
            
            overlay.style.display = 'flex';
            setTimeout(() => closeFeedback(), 2000);
        }
        
        // 피드백 닫기
        function closeFeedback() {
            document.getElementById('feedbackOverlay').style.display = 'none';
        }
        
        // AI 튜터 메시지 업데이트
        function updateTutorMessage(title, message) {
            const tutorMessage = document.getElementById('tutorMessage');
            tutorMessage.innerHTML = `<strong>${title}</strong><br><br>${message}`;
        }
        
        // 도움말
        function getTutorHelp() {
            const helpMessages = {
                consonant: '자음을 캔버스에 직접 써보세요! 가이드 버튼을 누르면 연한 글자가 나타나요. 그 위에 따라 써보세요!',
                vowel: '모음을 캔버스에 직접 써보세요! 획순을 생각하면서 천천히 써보세요!',
                combination: '자음과 모음이 합쳐진 글자를 써보세요! 어떻게 조합되는지 잘 보세요!',
                word: '완전한 단어를 써보세요! 각 글자의 간격도 생각하면서 써보세요!'
            };
            
            updateTutorMessage('💡 도움말', helpMessages[currentLevel]);
        }
        
        // 콘솔에 학습 데이터 출력 (개발자용)
        function exportLearningData() {
            console.log('=== 학습 데이터 ===');
            console.log('총 문제 수:', learningStats.totalProblems);
            console.log('정답 수:', learningStats.correctProblems);
            console.log('정답률:', Math.round((learningStats.correctProblems / learningStats.totalProblems) * 100) + '%');
            console.log('평균 응답 시간:', Math.round(learningStats.responseTimes.reduce((a, b) => a + b, 0) / learningStats.responseTimes.length) + 'ms');
            console.log('세부 로그:', learningStats.problemLog);
            return learningStats;
        }
        
        // 전역에서 데이터 접근 가능하도록
        window.exportLearningData = exportLearningData;
    </script>
</body>
</html>