<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>한글이와 함께 - 듣기 단계 학습</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            font-size: 20px;
            color: #1e293b;
            overflow: hidden;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 3fr;
            height: 100vh;
            gap: 25px;
            padding: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* AI 튜터 사이드바 */
        .ai-tutor-sidebar {
            background: white;
            border-radius: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            border: 4px solid #3b82f6;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 320px;
        }

        .tutor-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .tutor-avatar {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            border: 4px solid #60a5fa;
            animation: gentle-bounce 3s ease-in-out infinite;
        }

        @keyframes gentle-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .tutor-name {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .tutor-status {
            font-size: 14px;
            opacity: 0.9;
        }

        .tutor-body {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .tutor-message {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
            font-size: 16px;
            line-height: 1.5;
            min-height: 120px;
            display: flex;
            align-items: center;
        }

        /* 저장 상태 표시 */
        .save-status {
            background: #f0fdf4;
            border: 2px solid #22c55e;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
            color: #15803d;
        }

        .save-status.error {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }

        /* 토글 섹션들 */
        .toggle-section {
            background: #f8fafc;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
            overflow: hidden;
        }

        .toggle-header {
            background: #e2e8f0;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: #374151;
            transition: background 0.3s ease;
        }

        .toggle-header:hover {
            background: #cbd5e1;
        }

        .toggle-content {
            padding: 15px;
            display: none;
        }

        .toggle-content.active {
            display: block;
        }

        .toggle-arrow {
            transition: transform 0.3s ease;
        }

        .toggle-arrow.rotated {
            transform: rotate(180deg);
        }

        /* 학습 레벨 선택 */
        .level-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .level-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: white;
            border: 2px solid #d1d5db;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .level-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        /* 반복 설정 */
        .setting-group {
            margin-bottom: 12px;
        }

        .setting-label {
            font-size: 14px;
            font-weight: bold;
            color: #374151;
            margin-bottom: 6px;
            display: block;
        }

        .setting-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .repeat-counter {
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 16px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }

        .adjust-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 8px;
            background: #3b82f6;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }

        /* 진행상태 */
        .progress-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e2e8f0;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.5s ease;
        }

        .tutor-controls {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .tutor-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: #3b82f6;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tutor-btn:active {
            transform: scale(0.95);
            background: #2563eb;
        }

        .tutor-btn.reset {
            background: #ef4444;
        }

        /* 메인 학습 영역 */
        .main-learning-area {
            background: white;
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            border: 3px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .learning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 20px;
            color: white;
        }

        .lesson-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .lesson-title {
            font-size: 24px;
            font-weight: bold;
        }

        .lesson-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(white 0%, rgba(255,255,255,0.3) 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6366f1;
            font-weight: bold;
            font-size: 14px;
        }

        .repeat-status {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        /* 듣기 학습 영역 */
        .listening-content {
            flex: 1;
            background: #f8fafc;
            border-radius: 20px;
            padding: 30px;
            border: 2px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 400px;
            text-align: center;
        }

        .audio-display {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            border: 3px solid #3b82f6;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .sound-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .play-button {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .play-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3);
        }

        .play-button:active {
            transform: scale(0.95);
        }

        .play-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        /* 힌트 영역 */
        .hint-section {
            background: #fffbeb;
            border: 2px solid #fbbf24;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .hint-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .hint-image {
            width: 80px;
            height: 80px;
            font-size: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 50%;
            border: 3px solid #fbbf24;
        }

        .hint-text {
            flex: 1;
            text-align: left;
        }

        .hint-title {
            font-size: 16px;
            font-weight: bold;
            color: #92400e;
            margin-bottom: 5px;
        }

        .hint-description {
            font-size: 14px;
            color: #78350f;
        }

        /* 선택지 */
        .listening-choices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .choice-btn {
            padding: 20px;
            border: none;
            border-radius: 15px;
            background: white;
            border: 3px solid #d1d5db;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .choice-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateY(-2px);
        }

        .choice-btn.correct {
            background: #dcfce7;
            border-color: #22c55e;
            animation: correctPulse 0.8s ease;
        }

        .choice-btn.incorrect {
            background: #fef2f2;
            border-color: #ef4444;
            animation: shake 0.6s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: #bbf7d0; }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* 타이머 */
        .timer-display {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        /* 액션 버튼들 */
        .action-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .action-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .action-btn.next {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        /* 피드백 오버레이 */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .feedback-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .feedback-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .feedback-text {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .feedback-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            background: #3b82f6;
            color: white;
        }

        /* 복원 모달 */
        .restore-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .restore-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .restore-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .restore-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #374151;
        }

        .restore-description {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .restore-buttons {
            display: flex;
            gap: 15px;
        }

        .restore-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restore-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .restore-btn.secondary {
            background: #e5e7eb;
            color: #374151;
        }

        /* 반응형 */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr 2fr;
                gap: 20px;
                padding: 20px;
            }
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                gap: 15px;
                padding: 15px;
            }
            
            .ai-tutor-sidebar {
                max-height: 400px;
                min-width: auto;
            }
            
            .listening-choices {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- AI 튜터 사이드바 -->
        <div class="ai-tutor-sidebar">
            <div class="tutor-header">
                <div class="tutor-avatar">🎧</div>
                <div class="tutor-name">AI 듣기선생님</div>
                <div class="tutor-status">소리로 배워요!</div>
            </div>
            <div class="tutor-body">
                <div class="save-status" id="saveStatus">
                    💾 자동 저장됨
                </div>

                <div class="tutor-message" id="tutorMessage">
                    안녕하세요! 듣기를 통해 한글을 배우는 시간이에요. 
                    소리를 잘 들어보고 맞는 글자를 찾아보세요! 🎵
                </div>
                
                <!-- 학습 단계 선택 (토글) -->
                <div class="toggle-section">
                    <div class="toggle-header" onclick="toggleSection('level')">
                        📚 학습 단계 선택
                        <span class="toggle-arrow" id="levelArrow">▼</span>
                    </div>
                    <div class="toggle-content" id="levelContent">
                        <div class="level-buttons">
                            <button class="level-btn active" onclick="selectLevel('consonant')">1단계: 자음 듣기</button>
                            <button class="level-btn" onclick="selectLevel('vowel')">2단계: 모음 듣기</button>
                            <button class="level-btn" onclick="selectLevel('combination')">3단계: 글자 듣기</button>
                            <button class="level-btn" onclick="selectLevel('word')">4단계: 단어 듣기</button>
                        </div>
                    </div>
                </div>
                
                <!-- 반복 설정 (토글) -->
                <div class="toggle-section">
                    <div class="toggle-header" onclick="toggleSection('settings')">
                        ⚙️ 반복 설정
                        <span class="toggle-arrow" id="settingsArrow">▼</span>
                    </div>
                    <div class="toggle-content" id="settingsContent">
                        <div class="setting-group">
                            <label class="setting-label">맞췄을 때 반복</label>
                            <div class="setting-controls">
                                <button class="adjust-btn" onclick="adjustRepeat('correct', -1)">-</button>
                                <div class="repeat-counter" id="correctRepeat">3</div>
                                <button class="adjust-btn" onclick="adjustRepeat('correct', 1)">+</button>
                            </div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">틀렸을 때 반복</label>
                            <div class="setting-controls">
                                <button class="adjust-btn" onclick="adjustRepeat('incorrect', -1)">-</button>
                                <div class="repeat-counter" id="incorrectRepeat">5</div>
                                <button class="adjust-btn" onclick="adjustRepeat('incorrect', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 진행상태 (토글) -->
                <div class="toggle-section">
                    <div class="toggle-header" onclick="toggleSection('progress')">
                        📊 진행상태
                        <span class="toggle-arrow" id="progressArrow">▼</span>
                    </div>
                    <div class="toggle-content active" id="progressContent">
                        <div class="progress-section">
                            <div class="progress-item">
                                <span>현재 학습:</span>
                                <span id="currentProgress">자음 1/10</span>
                            </div>
                            <div class="progress-item">
                                <span>반복 진행:</span>
                                <span id="repeatProgress">1/3</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 10%"></div>
                            </div>
                            <div class="progress-item">
                                <span>정답률:</span>
                                <span id="accuracy">0%</span>
                            </div>
                            <div class="progress-item">
                                <span>평균 시간:</span>
                                <span id="avgTime">0초</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tutor-controls">
                    <button class="tutor-btn" onclick="getTutorHelp()">💡 도움말</button>
                    <button class="tutor-btn" onclick="playCurrentSound()">🔊 다시듣기</button>
                    <button class="tutor-btn reset" onclick="showResetConfirm()">🔄 초기화</button>
                </div>
            </div>
        </div>

        <!-- 메인 학습 영역 -->
        <div class="main-learning-area">
            <!-- 상단 헤더 -->
            <div class="learning-header">
                <div class="lesson-info">
                    <div class="lesson-title" id="lessonTitle">자음 듣기 학습</div>
                    <div class="lesson-subtitle" id="lessonSubtitle">소리를 듣고 맞는 자음을 찾아보세요</div>
                </div>
                <div class="progress-info">
                    <div class="repeat-status" id="repeatStatus">반복: 1/3</div>
                    <div class="progress-circle" id="progressCircle">10%</div>
                </div>
            </div>

            <!-- 듣기 학습 콘텐츠 -->
            <div class="listening-content">
                <div class="timer-display" id="timerDisplay">0초</div>
                
                <div class="audio-display">
                    <div class="sound-icon">🔊</div>
                    <button class="play-button" id="playButton" onclick="playCurrentSound()">
                        🎵 소리 듣기
                    </button>
                    <p style="font-size: 18px; color: #6b7280; margin-top: 15px;">
                        버튼을 눌러 소리를 들어보세요
                    </p>
                </div>

                <!-- 힌트 섹션 -->
                <div class="hint-section" id="hintSection">
                    <div class="hint-content">
                        <div class="hint-image" id="hintImage">🐱</div>
                        <div class="hint-text">
                            <div class="hint-title">힌트</div>
                            <div class="hint-description" id="hintDescription">고양이의 'ㄱ' 소리에요</div>
                        </div>
                    </div>
                </div>

                <p style="font-size: 20px; margin-bottom: 20px; font-weight: bold; color: #374151;">
                    들은 소리와 같은 글자를 선택하세요!
                </p>
                
                <div class="listening-choices" id="listeningChoices">
                    <!-- 동적으로 생성됨 -->
                </div>
            </div>

            <!-- 하단 액션 버튼들 -->
            <div class="action-controls">
                <button class="action-btn primary" onclick="markCorrect()">✅ 정답이에요!</button>
                <button class="action-btn secondary" onclick="markIncorrect()">❌ 틀렸어요</button>
                <button class="action-btn next" onclick="nextQuestion()">➡️ 다음 문제</button>
            </div>
        </div>
    </div>

    <!-- 피드백 오버레이 -->
    <div class="feedback-overlay" id="feedbackOverlay">
        <div class="feedback-content">
            <div class="feedback-icon" id="feedbackIcon">🎉</div>
            <div class="feedback-text" id="feedbackText">정말 잘했어요!</div>
            <button class="feedback-btn" onclick="closeFeedback()">계속하기</button>
        </div>
    </div>

    <!-- 진행상황 복원 모달 -->
    <div class="restore-modal" id="restoreModal">
        <div class="restore-content">
            <div class="restore-icon">📚</div>
            <div class="restore-title">이전 학습을 발견했어요!</div>
            <div class="restore-description" id="restoreDescription">
                자음 듣기 3번째 문제에서 중단되었습니다.<br>
                이어서 학습하시겠어요?
            </div>
            <div class="restore-buttons">
                <button class="restore-btn primary" onclick="restoreProgress()">이어서 하기</button>
                <button class="restore-btn secondary" onclick="startFresh()">새로 시작</button>
            </div>
        </div>
    </div>

    <script>
        // localStorage 키 상수
        const STORAGE_KEYS = {
            CURRENT_STATE: 'korean_listening_current_state',
            LEARNING_DATA: 'korean_listening_learning_data',
            SETTINGS: 'korean_listening_settings',
            LAST_SAVE: 'korean_listening_last_save'
        };

        // 전역 상태 관리
        let currentLevel = 'consonant';
        let currentItemIndex = 0;
        let currentRepeat = 1;
        let startTime = 0;
        let isAnswered = false;
        
        // 반복 설정
        let repeatSettings = {
            correct: 3,
            incorrect: 5
        };
        
        // 데이터 수집을 위한 변수들
        let learningData = {
            totalQuestions: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
            totalTime: 0,
            responses: [], // 각 문제별 상세 데이터
            sessionStart: new Date()
        };
        
        // 학습 콘텐츠 데이터베이스
        const contentDatabase = {
            consonant: [
                { 
                    letter: 'ㄱ', 
                    name: '기역', 
                    sound: 'ㄱ', 
                    example: '고양이의 ㄱ',
                    image: '🐱',
                    keywords: ['고양이', '가방', '거북이']
                },
                { 
                    letter: 'ㄴ', 
                    name: '니은', 
                    sound: 'ㄴ', 
                    example: '나비의 ㄴ',
                    image: '🦋',
                    keywords: ['나비', '나무', '노란색']
                },
                { 
                    letter: 'ㄷ', 
                    name: '디귿', 
                    sound: 'ㄷ', 
                    example: '다람쥐의 ㄷ',
                    image: '🐿️',
                    keywords: ['다람쥐', '달', '도마뱀']
                },
                { 
                    letter: 'ㄹ', 
                    name: '리을', 
                    sound: 'ㄹ', 
                    example: '라면의 ㄹ',
                    image: '🍜',
                    keywords: ['라면', '로봇', '리본']
                },
                { 
                    letter: 'ㅁ', 
                    name: '미음', 
                    sound: 'ㅁ', 
                    example: '모자의 ㅁ',
                    image: '🎩',
                    keywords: ['모자', '마우스', '문어']
                },
                { 
                    letter: 'ㅂ', 
                    name: '비읍', 
                    sound: 'ㅂ', 
                    example: '바나나의 ㅂ',
                    image: '🍌',
                    keywords: ['바나나', '버스', '불']
                },
                { 
                    letter: 'ㅅ', 
                    name: '시옷', 
                    sound: 'ㅅ', 
                    example: '사과의 ㅅ',
                    image: '🍎',
                    keywords: ['사과', '수박', '선물']
                },
                { 
                    letter: 'ㅇ', 
                    name: '이응', 
                    sound: 'ㅇ', 
                    example: '아기의 ㅇ',
                    image: '👶',
                    keywords: ['아기', '우산', '오리']
                },
                { 
                    letter: 'ㅈ', 
                    name: '지읒', 
                    sound: 'ㅈ', 
                    example: '자동차의 ㅈ',
                    image: '🚗',
                    keywords: ['자동차', '지우개', '주스']
                },
                { 
                    letter: 'ㅊ', 
                    name: '치읓', 
                    sound: 'ㅊ', 
                    example: '치킨의 ㅊ',
                    image: '🍗',
                    keywords: ['치킨', '차', '체리']
                }
            ],
            vowel: [
                { 
                    letter: 'ㅏ', 
                    name: '아', 
                    sound: '아', 
                    example: '아기의 ㅏ',
                    image: '👶',
                    keywords: ['아기', '아빠', '아이스크림']
                },
                { 
                    letter: 'ㅑ', 
                    name: '야', 
                    sound: '야', 
                    example: '야구의 ㅑ',
                    image: '⚾',
                    keywords: ['야구', '야채', '야옹이']
                },
                { 
                    letter: 'ㅓ', 
                    name: '어', 
                    sound: '어', 
                    example: '어머니의 ㅓ',
                    image: '👩',
                    keywords: ['어머니', '어린이', '얼굴']
                },
                { 
                    letter: 'ㅕ', 
                    name: '여', 
                    sound: '여', 
                    example: '여우의 ㅕ',
                    image: '🦊',
                    keywords: ['여우', '여름', '여행']
                },
                { 
                    letter: 'ㅗ', 
                    name: '오', 
                    sound: '오', 
                    example: '오리의 ㅗ',
                    image: '🦆',
                    keywords: ['오리', '오렌지', '오토바이']
                },
                { 
                    letter: 'ㅛ', 
                    name: '요', 
                    sound: '요', 
                    example: '요구르트의 ㅛ',
                    image: '🥛',
                    keywords: ['요구르트', '요리', '요트']
                },
                { 
                    letter: 'ㅜ', 
                    name: '우', 
                    sound: '우', 
                    example: '우유의 ㅜ',
                    image: '🥛',
                    keywords: ['우유', '우산', '우주']
                },
                { 
                    letter: 'ㅠ', 
                    name: '유', 
                    sound: '유', 
                    example: '유리의 ㅠ',
                    image: '🪟',
                    keywords: ['유리', '유치원', '유령']
                },
                { 
                    letter: 'ㅡ', 
                    name: '으', 
                    sound: '으', 
                    example: '음식의 ㅡ',
                    image: '🍽️',
                    keywords: ['음식', '으음', '은행']
                },
                { 
                    letter: 'ㅣ', 
                    name: '이', 
                    sound: '이', 
                    example: '이빨의 ㅣ',
                    image: '🦷',
                    keywords: ['이빨', '이름', '이불']
                }
            ],
            combination: [
                { 
                    consonant: 'ㄱ', 
                    vowel: 'ㅏ', 
                    result: '가', 
                    sound: '가',
                    example: '가방의 가',
                    image: '🎒',
                    keywords: ['가방', '가족', '가게']
                },
                { 
                    consonant: 'ㄴ', 
                    vowel: 'ㅏ', 
                    result: '나', 
                    sound: '나',
                    example: '나비의 나',
                    image: '🦋',
                    keywords: ['나비', '나무', '나라']
                },
                { 
                    consonant: 'ㄷ', 
                    vowel: 'ㅏ', 
                    result: '다', 
                    sound: '다',
                    example: '다람쥐의 다',
                    image: '🐿️',
                    keywords: ['다람쥐', '달', '다리']
                },
                { 
                    consonant: 'ㄹ', 
                    vowel: 'ㅏ', 
                    result: '라', 
                    sound: '라',
                    example: '라면의 라',
                    image: '🍜',
                    keywords: ['라면', '라디오', '라이온']
                },
                { 
                    consonant: 'ㅁ', 
                    vowel: 'ㅏ', 
                    result: '마', 
                    sound: '마',
                    example: '마우스의 마',
                    image: '🖱️',
                    keywords: ['마우스', '마음', '마법']
                },
                { 
                    consonant: 'ㅂ', 
                    vowel: 'ㅏ', 
                    result: '바', 
                    sound: '바',
                    example: '바나나의 바',
                    image: '🍌',
                    keywords: ['바나나', '바다', '바람']
                },
                { 
                    consonant: 'ㅅ', 
                    vowel: 'ㅏ', 
                    result: '사', 
                    sound: '사',
                    example: '사과의 사',
                    image: '🍎',
                    keywords: ['사과', '사자', '사람']
                },
                { 
                    consonant: 'ㅇ', 
                    vowel: 'ㅏ', 
                    result: '아', 
                    sound: '아',
                    example: '아기의 아',
                    image: '👶',
                    keywords: ['아기', '아빠', '아침']
                }
            ],
            word: [
                { 
                    word: '가방', 
                    syllables: ['가', '방'], 
                    sound: '가방',
                    image: '🎒', 
                    meaning: '책을 넣는 것',
                    keywords: ['학교', '책', '학생']
                },
                { 
                    word: '나비', 
                    syllables: ['나', '비'], 
                    sound: '나비',
                    image: '🦋', 
                    meaning: '예쁜 날개가 있는 곤충',
                    keywords: ['꽃', '날개', '색깔']
                },
                { 
                    word: '다리', 
                    syllables: ['다', '리'], 
                    sound: '다리',
                    image: '🦵', 
                    meaning: '걸을 때 사용하는 몸의 부분',
                    keywords: ['걷기', '뛰기', '몸']
                },
                { 
                    word: '라면', 
                    syllables: ['라', '면'], 
                    sound: '라면',
                    image: '🍜', 
                    meaning: '맛있는 면 요리',
                    keywords: ['음식', '뜨거운', '맛있는']
                },
                { 
                    word: '마음', 
                    syllables: ['마', '음'], 
                    sound: '마음',
                    image: '❤️', 
                    meaning: '사랑하는 기분',
                    keywords: ['사랑', '기분', '감정']
                },
                { 
                    word: '바다', 
                    syllables: ['바', '다'], 
                    sound: '바다',
                    image: '🌊', 
                    meaning: '넓고 푸른 물',
                    keywords: ['물', '파도', '고래']
                },
                { 
                    word: '사과', 
                    syllables: ['사', '과'], 
                    sound: '사과',
                    image: '🍎', 
                    meaning: '빨간 과일',
                    keywords: ['과일', '빨간색', '달콤한']
                },
                { 
                    word: '아기', 
                    syllables: ['아', '기'], 
                    sound: '아기',
                    image: '👶', 
                    meaning: '작고 귀여운 사람',
                    keywords: ['어린이', '귀여운', '작은']
                }
            ]
        };

        // =================
        // localStorage 관리 함수들
        // =================

        // 현재 상태 저장
        function saveCurrentState() {
            try {
                const currentState = {
                    currentLevel,
                    currentItemIndex,
                    currentRepeat,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem(STORAGE_KEYS.CURRENT_STATE, JSON.stringify(currentState));
                localStorage.setItem(STORAGE_KEYS.LAST_SAVE, new Date().toISOString());
                
                updateSaveStatus('success', '💾 자동 저장됨');
                return true;
            } catch (error) {
                console.error('저장 실패:', error);
                updateSaveStatus('error', '❌ 저장 실패');
                return false;
            }
        }

        // 학습 데이터 저장
        function saveLearningData() {
            try {
                localStorage.setItem(STORAGE_KEYS.LEARNING_DATA, JSON.stringify(learningData));
                return true;
            } catch (error) {
                console.error('학습 데이터 저장 실패:', error);
                return false;
            }
        }

        // 설정 저장
        function saveSettings() {
            try {
                const settings = {
                    repeatSettings,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
                return true;
            } catch (error) {
                console.error('설정 저장 실패:', error);
                return false;
            }
        }

        // 모든 데이터 저장
        function saveAllData() {
            const success = saveCurrentState() && saveLearningData() && saveSettings();
            if (!success) {
                updateSaveStatus('error', '❌ 일부 저장 실패');
            }
            return success;
        }

        // 저장된 상태 불러오기
        function loadSavedState() {
            try {
                const savedState = localStorage.getItem(STORAGE_KEYS.CURRENT_STATE);
                const savedData = localStorage.getItem(STORAGE_KEYS.LEARNING_DATA);
                const savedSettings = localStorage.getItem(STORAGE_KEYS.SETTINGS);

                if (savedState) {
                    const state = JSON.parse(savedState);
                    const saveDate = new Date(state.timestamp);
                    const now = new Date();
                    const daysDiff = Math.floor((now - saveDate) / (1000 * 60 * 60 * 24));

                    // 7일 이내의 데이터만 복원 제안
                    if (daysDiff <= 7) {
                        return {
                            state: state,
                            data: savedData ? JSON.parse(savedData) : null,
                            settings: savedSettings ? JSON.parse(savedSettings) : null,
                            isValid: true
                        };
                    }
                }
                return null;
            } catch (error) {
                console.error('저장된 데이터 불러오기 실패:', error);
                return null;
            }
        }

        // 진행상황 복원
        function restoreProgress() {
            const savedData = loadSavedState();
            if (savedData && savedData.isValid) {
                const { state, data, settings } = savedData;
                
                // 상태 복원
                currentLevel = state.currentLevel;
                currentItemIndex = state.currentItemIndex;
                currentRepeat = state.currentRepeat;
                
                // 학습 데이터 복원
                if (data) {
                    learningData = { ...learningData, ...data };
                }
                
                // 설정 복원
                if (settings && settings.repeatSettings) {
                    repeatSettings = settings.repeatSettings;
                    document.getElementById('correctRepeat').textContent = repeatSettings.correct;
                    document.getElementById('incorrectRepeat').textContent = repeatSettings.incorrect;
                }
                
                // UI 업데이트
                selectLevelButton(currentLevel);
                updateContent();
                updateUI();
                
                updateTutorMessage('📚 복원 완료', 
                    `이전 학습이 복원되었어요! ${getLevelKoreanName(currentLevel)} ${currentItemIndex + 1}번째 문제부터 이어서 진행해요! 🎯`);
                
                hideRestoreModal();
                updateSaveStatus('success', '📚 진행상황 복원됨');
                
                return true;
            }
            return false;
        }

        // 새로 시작
        function startFresh() {
            clearAllSavedData();
            currentLevel = 'consonant';
            currentItemIndex = 0;
            currentRepeat = 1;
            
            // 학습 데이터 리셋
            learningData = {
                totalQuestions: 0,
                correctAnswers: 0,
                incorrectAnswers: 0,
                totalTime: 0,
                responses: [],
                sessionStart: new Date()
            };
            
            selectLevelButton('consonant');
            updateContent();
            updateUI();
            
            hideRestoreModal();
            updateTutorMessage('🌟 새로운 시작', 
                '새로운 학습을 시작해요! 자음부터 차근차근 배워봐요! 💪');
            updateSaveStatus('success', '🌟 새로 시작함');
        }

        // 저장된 데이터 모두 삭제
        function clearAllSavedData() {
            try {
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                updateSaveStatus('success', '🗑️ 데이터 초기화됨');
                return true;
            } catch (error) {
                console.error('데이터 삭제 실패:', error);
                updateSaveStatus('error', '❌ 삭제 실패');
                return false;
            }
        }

        // 저장 상태 표시 업데이트
        function updateSaveStatus(type, message) {
            const saveStatus = document.getElementById('saveStatus');
            saveStatus.textContent = message;
            saveStatus.className = type === 'error' ? 'save-status error' : 'save-status';
            
            // 3초 후 기본 메시지로 복원
            setTimeout(() => {
                if (type !== 'error') {
                    saveStatus.textContent = '💾 자동 저장됨';
                    saveStatus.className = 'save-status';
                }
            }, 3000);
        }

        // 복원 모달 표시
        function showRestoreModal(savedData) {
            const modal = document.getElementById('restoreModal');
            const description = document.getElementById('restoreDescription');
            
            if (savedData && savedData.state) {
                const { currentLevel: level, currentItemIndex: index, currentRepeat: repeat } = savedData.state;
                const levelName = getLevelKoreanName(level);
                const saveDate = new Date(savedData.state.timestamp);
                const timeAgo = getTimeAgo(saveDate);
                
                description.innerHTML = `
                    <strong>${levelName} ${index + 1}번째 문제 (${repeat}번째 반복)</strong>에서 중단되었습니다.<br>
                    마지막 저장: ${timeAgo}<br><br>
                    이어서 학습하시겠어요?
                `;
            }
            
            modal.style.display = 'flex';
        }

        // 복원 모달 숨기기
        function hideRestoreModal() {
            document.getElementById('restoreModal').style.display = 'none';
        }

        // 시간 차이를 사람이 읽기 쉬운 형태로 변환
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}일 전`;
            if (hours > 0) return `${hours}시간 전`;
            if (minutes > 0) return `${minutes}분 전`;
            return '방금 전';
        }

        // 초기화 확인
        function showResetConfirm() {
            if (confirm('⚠️ 모든 진행상황과 데이터가 삭제됩니다.\n정말 초기화하시겠어요?')) {
                startFresh();
                updateTutorMessage('🔄 초기화 완료', 
                    '모든 데이터가 초기화되었어요. 새로운 마음으로 시작해봐요! 🌱');
            }
        }

        // =================
        // 기존 함수들 (수정된 부분)
        // =================
        
        // 토글 기능
        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + 'Content');
            const arrow = document.getElementById(sectionName + 'Arrow');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.classList.remove('rotated');
                arrow.textContent = '▼';
            } else {
                content.classList.add('active');
                arrow.classList.add('rotated');
                arrow.textContent = '▲';
            }
        }
        
        // 레벨 선택 (저장 기능 추가)
        function selectLevel(level) {
            selectLevelButton(level);
            
            currentLevel = level;
            currentItemIndex = 0;
            currentRepeat = 1;
            
            // 콘텐츠 업데이트
            updateContent();
            updateUI();
            
            // 데이터 수집 리셋 (기존 학습은 유지)
            // learningData.responses = []; // 제거 - 누적된 데이터 유지
            
            // 저장
            saveAllData();
        }

        // 레벨 버튼 선택 상태 업데이트
        function selectLevelButton(level) {
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const levelButtons = document.querySelectorAll('.level-btn');
            const levelIndex = ['consonant', 'vowel', 'combination', 'word'].indexOf(level);
            if (levelIndex >= 0 && levelButtons[levelIndex]) {
                levelButtons[levelIndex].classList.add('active');
            }
        }
        
        // 콘텐츠 업데이트 (저장 기능 추가)
        function updateContent() {
            const currentData = contentDatabase[currentLevel];
            const currentItem = currentData[currentItemIndex];
            
            // 제목 업데이트
            const levelNames = {
                consonant: '자음 듣기 학습',
                vowel: '모음 듣기 학습',
                combination: '글자 듣기 학습',
                word: '단어 듣기 학습'
            };
            
            document.getElementById('lessonTitle').textContent = levelNames[currentLevel];
            
            // 부제목 업데이트
            let subtitle = '';
            switch(currentLevel) {
                case 'consonant':
                case 'vowel':
                    subtitle = `'${currentItem.letter}' 소리를 듣고 찾아보세요`;
                    break;
                case 'combination':
                    subtitle = `'${currentItem.result}' 소리를 듣고 찾아보세요`;
                    break;
                case 'word':
                    subtitle = `'${currentItem.word}' 소리를 듣고 찾아보세요`;
                    break;
            }
            document.getElementById('lessonSubtitle').textContent = subtitle;
            
            // 힌트 업데이트 (랜덤하게 선택)
            updateHint();
            
            // 선택지 생성
            generateChoices();
            
            // 타이머 리셋
            startTime = Date.now();
            updateTimer();
            
            // 답변 상태 리셋
            isAnswered = false;
            
            // 저장
            saveCurrentState();
        }
        
        // 힌트 업데이트 (랜덤)
        function updateHint() {
            const currentData = contentDatabase[currentLevel];
            const currentItem = currentData[currentItemIndex];
            
            // 키워드에서 랜덤하게 하나 선택
            const randomKeyword = currentItem.keywords[Math.floor(Math.random() * currentItem.keywords.length)];
            
            // 이미지와 설명 업데이트
            document.getElementById('hintImage').textContent = currentItem.image;
            
            let description = '';
            switch(currentLevel) {
                case 'consonant':
                case 'vowel':
                    description = `${randomKeyword}의 '${currentItem.letter}' 소리에요`;
                    break;
                case 'combination':
                    description = `${randomKeyword}의 '${currentItem.result}' 소리에요`;
                    break;
                case 'word':
                    description = `${currentItem.meaning} - ${randomKeyword}와 관련있어요`;
                    break;
            }
            
            document.getElementById('hintDescription').textContent = description;
        }
        
        // 선택지 생성 (랜덤)
        function generateChoices() {
            const container = document.getElementById('listeningChoices');
            const currentData = contentDatabase[currentLevel];
            const currentItem = currentData[currentItemIndex];
            
            // 정답 결정
            let correctAnswer;
            switch(currentLevel) {
                case 'consonant':
                case 'vowel':
                    correctAnswer = currentItem.letter;
                    break;
                case 'combination':
                    correctAnswer = currentItem.result;
                    break;
                case 'word':
                    correctAnswer = currentItem.word;
                    break;
            }
            
            // 오답 선택지 생성 (랜덤하게 4개)
            let wrongAnswers = [];
            const otherItems = currentData.filter((_, index) => index !== currentItemIndex);
            
            // 랜덤하게 섞기
            const shuffledItems = otherItems.sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < Math.min(4, shuffledItems.length); i++) {
                switch(currentLevel) {
                    case 'consonant':
                    case 'vowel':
                        wrongAnswers.push(shuffledItems[i].letter);
                        break;
                    case 'combination':
                        wrongAnswers.push(shuffledItems[i].result);
                        break;
                    case 'word':
                        wrongAnswers.push(shuffledItems[i].word);
                        break;
                }
            }
            
            // 전체 선택지 (정답 + 오답) 랜덤 배치
            const allChoices = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5);
            
            container.innerHTML = '';
            
            allChoices.forEach(choice => {
                const choiceBtn = document.createElement('button');
                choiceBtn.className = 'choice-btn';
                choiceBtn.textContent = choice;
                choiceBtn.onclick = () => selectChoice(choice, correctAnswer);
                container.appendChild(choiceBtn);
            });
        }
        
        // 선택 처리 (저장 기능 추가)
        function selectChoice(selectedChoice, correctAnswer) {
            if (isAnswered) return;
            
            const responseTime = Date.now() - startTime;
            const isCorrect = selectedChoice === correctAnswer;
            
            // 선택지 비활성화
            const buttons = document.querySelectorAll('.choice-btn');
            buttons.forEach(btn => {
                btn.style.pointerEvents = 'none';
                btn.classList.remove('correct', 'incorrect');
            });
            
            // 선택된 버튼에 피드백 적용
            const selectedButton = Array.from(buttons).find(btn => 
                btn.textContent === selectedChoice
            );
            
            if (selectedButton) {
                selectedButton.classList.add(isCorrect ? 'correct' : 'incorrect');
            }
            
            // 데이터 수집
            collectResponseData(selectedChoice, correctAnswer, responseTime, isCorrect);
            
            isAnswered = true;
            
            if (isCorrect) {
                updateTutorMessage('🎉 정답이에요!', 
                    `"${selectedChoice}"를 정확히 찾았네요! 정말 잘했어요! 👏`);
                setTimeout(() => {
                    markCorrect();
                    resetChoices();
                }, 1500);
            } else {
                updateTutorMessage('😊 다시 생각해보세요!', 
                    `정답은 "${correctAnswer}"이에요. 소리를 다시 들어보고 기억해보세요! 💡`);
                setTimeout(() => {
                    markIncorrect();
                    resetChoices();
                }, 2500);
            }
            
            // 저장
            saveLearningData();
        }
        
        // 데이터 수집 (저장 기능 추가)
        function collectResponseData(selectedAnswer, correctAnswer, responseTime, isCorrect) {
            const currentData = contentDatabase[currentLevel];
            const currentItem = currentData[currentItemIndex];
            
            const responseData = {
                timestamp: new Date(),
                level: currentLevel,
                itemIndex: currentItemIndex,
                currentItem: currentItem,
                selectedAnswer: selectedAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                responseTime: responseTime,
                repeatCount: currentRepeat,
                hint: document.getElementById('hintDescription').textContent
            };
            
            learningData.responses.push(responseData);
            learningData.totalQuestions++;
            learningData.totalTime += responseTime;
            
            if (isCorrect) {
                learningData.correctAnswers++;
            } else {
                learningData.incorrectAnswers++;
            }
            
            // 진행상태 업데이트
            updateProgressDisplay();
            
            console.log('학습 데이터:', responseData); // 개발용 로그
        }
        
        // 진행상태 표시 업데이트
        function updateProgressDisplay() {
            const totalItems = contentDatabase[currentLevel].length;
            const accuracy = learningData.totalQuestions > 0 ? 
                Math.round((learningData.correctAnswers / learningData.totalQuestions) * 100) : 0;
            const avgTime = learningData.totalQuestions > 0 ? 
                Math.round(learningData.totalTime / learningData.totalQuestions / 1000) : 0;
            
            document.getElementById('currentProgress').textContent = 
                `${getLevelKoreanName(currentLevel)} ${currentItemIndex + 1}/${totalItems}`;
            document.getElementById('repeatProgress').textContent = 
                `${currentRepeat}/${repeatSettings.correct}`;
            document.getElementById('accuracy').textContent = `${accuracy}%`;
            document.getElementById('avgTime').textContent = `${avgTime}초`;
            
            // 프로그레스 바 업데이트
            const overallProgress = ((currentItemIndex + (currentRepeat / repeatSettings.correct)) / totalItems) * 100;
            document.getElementById('progressFill').style.width = `${Math.min(100, overallProgress)}%`;
            document.getElementById('progressCircle').textContent = `${Math.round(overallProgress)}%`;
            
            // 원형 프로그레스 업데이트
            const progressCircle = document.getElementById('progressCircle');
            const progressValue = Math.min(100, overallProgress);
            progressCircle.style.background = 
                `conic-gradient(white ${progressValue}%, rgba(255,255,255,0.3) ${progressValue}%)`;
        }
        
        // 레벨 한국어 이름
        function getLevelKoreanName(level) {
            const names = {
                consonant: '자음',
                vowel: '모음',
                combination: '글자',
                word: '단어'
            };
            return names[level];
        }
        
        // 선택지 리셋
        function resetChoices() {
            const buttons = document.querySelectorAll('.choice-btn');
            buttons.forEach(btn => {
                btn.classList.remove('correct', 'incorrect');
                btn.style.pointerEvents = 'auto';
            });
        }
        
        // 현재 소리 재생 (TTS)
        function playCurrentSound() {
            const currentData = contentDatabase[currentLevel];
            const currentItem = currentData[currentItemIndex];
            
            let textToSpeak = '';
            switch(currentLevel) {
                case 'consonant':
                case 'vowel':
                    textToSpeak = currentItem.sound;
                    break;
                case 'combination':
                case 'word':
                    textToSpeak = currentItem.sound;
                    break;
            }
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.6;
                utterance.pitch = 1.2;
                
                // 버튼 비활성화
                const playButton = document.getElementById('playButton');
                playButton.disabled = true;
                playButton.textContent = '🎵 재생중...';
                
                utterance.onend = () => {
                    playButton.disabled = false;
                    playButton.textContent = '🎵 소리 듣기';
                };
                
                speechSynthesis.speak(utterance);
                
                updateTutorMessage('🔊 소리 재생', 
                    `"${textToSpeak}" 소리를 들어보세요. 어떤 글자인지 맞춰보세요!`);
            }
        }
        
        // 타이머 업데이트
        function updateTimer() {
            if (startTime && !isAnswered) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timerDisplay').textContent = `${elapsed}초`;
                setTimeout(updateTimer, 1000);
            }
        }
        
        // UI 업데이트
        function updateUI() {
            updateProgressDisplay();
            document.getElementById('repeatStatus').textContent = `반복: ${currentRepeat}/${repeatSettings.correct}`;
        }
        
        // 반복 회수 조정 (저장 기능 추가)
        function adjustRepeat(type, delta) {
            const newValue = repeatSettings[type] + delta;
            if (newValue >= 1 && newValue <= 10) {
                repeatSettings[type] = newValue;
                document.getElementById(type + 'Repeat').textContent = newValue;
                
                updateTutorMessage('설정 변경', 
                    `${type === 'correct' ? '맞췄을 때' : '틀렸을 때'} 반복 횟수가 ${newValue}회로 설정되었어요! 👍`);
                
                updateUI();
                
                // 설정 저장
                saveSettings();
            }
        }
        
        // 정답 처리 (저장 기능 추가)
        function markCorrect() {
            if (currentRepeat < repeatSettings.correct) {
                currentRepeat++;
                updateTutorMessage('✨ 계속 진행', 
                    `${currentRepeat}번째 반복이에요! 조금 더 연습해봐요! 💪`);
                updateContent();
            } else {
                // 다음 문제로
                showFeedback(true, true);
            }
            updateUI();
            
            // 상태 저장
            saveCurrentState();
        }
        
        // 오답 처리 (저장 기능 추가)
        function markIncorrect() {
            currentRepeat = 1; // 틀리면 처음부터 다시
            updateTutorMessage('🔄 다시 도전', 
                `괜찮아요! 처음부터 다시 연습해봐요. 소리를 더 주의깊게 들어보세요! 👂`);
            setTimeout(() => {
                updateContent();
            }, 1000);
            updateUI();
            
            // 상태 저장
            saveCurrentState();
        }
        
        // 다음 문제 (저장 기능 추가)
        function nextQuestion() {
            if (currentRepeat >= repeatSettings.correct) {
                const totalItems = contentDatabase[currentLevel].length;
                
                if (currentItemIndex < totalItems - 1) {
                    currentItemIndex++;
                    currentRepeat = 1;
                    updateContent();
                    updateUI();
                    
                    updateTutorMessage('➡️ 다음 학습', 
                        `새로운 문제를 시작해요! 지금까지 잘하고 있어요! 🌟`);
                    
                    // 상태 저장
                    saveCurrentState();
                } else {
                    showLevelComplete();
                }
            } else {
                updateTutorMessage('🔄 반복 완료 필요', 
                    `현재 문제를 ${repeatSettings.correct}번 맞춰야 다음으로 넘어갈 수 있어요! 💪`);
            }
        }
        
        // 레벨 완료 (저장 기능 추가)
        function showLevelComplete() {
            const levelNames = {
                consonant: '자음 듣기',
                vowel: '모음 듣기',
                combination: '글자 듣기',
                word: '단어 듣기'
            };
            
            updateTutorMessage('🏆 레벨 완료!', 
                `${levelNames[currentLevel]} 단계를 모두 완료했어요! 정말 대단해요! 🎉`);
            
            // 최종 학습 데이터 출력
            console.log('최종 학습 데이터:', learningData);
            
            // 완료된 레벨 데이터 저장
            saveLearningData();
            
            showFeedback(true, true);
        }
        
        // 피드백 표시
        function showFeedback(isCorrect, isComplete) {
            const overlay = document.getElementById('feedbackOverlay');
            const icon = document.getElementById('feedbackIcon');
            const text = document.getElementById('feedbackText');
            
            if (isComplete) {
                icon.textContent = '🏆';
                text.textContent = '문제를 완료했어요!';
            } else if (isCorrect) {
                icon.textContent = '✨';
                text.textContent = '잘했어요! 한 번 더!';
            } else {
                icon.textContent = '💪';
                text.textContent = '다시 도전해봐요!';
            }
            
            overlay.style.display = 'flex';
            setTimeout(() => closeFeedback(), 2000);
        }
        
        // 피드백 닫기
        function closeFeedback() {
            document.getElementById('feedbackOverlay').style.display = 'none';
        }
        
        // AI 튜터 메시지 업데이트
        function updateTutorMessage(title, message) {
            const tutorMessage = document.getElementById('tutorMessage');
            tutorMessage.innerHTML = `<strong>${title}</strong><br><br>${message}`;
        }
        
        // 도움말
        function getTutorHelp() {
            const helpMessages = {
                consonant: '🎧 자음 듣기: 소리를 잘 들어보고 맞는 자음을 찾아보세요. 힌트의 이미지도 참고하세요!',
                vowel: '🎧 모음 듣기: 모음의 특별한 소리를 들어보세요. 입모양을 생각하면서 들어보세요!',
                combination: '🎧 글자 듣기: 자음과 모음이 합쳐진 소리를 들어보세요. 천천히 발음해보세요!',
                word: '🎧 단어 듣기: 완전한 단어의 소리를 들어보세요. 의미도 함께 생각해보세요!'
            };
            
            updateTutorMessage('💡 도움말', helpMessages[currentLevel]);
        }
        
        // 자동 저장 (주기적)
        function startAutoSave() {
            setInterval(() => {
                if (currentItemIndex > 0 || currentRepeat > 1 || learningData.totalQuestions > 0) {
                    saveAllData();
                }
            }, 30000); // 30초마다 자동 저장
        }

        // 페이지 종료 시 저장
        function setupBeforeUnloadSave() {
            window.addEventListener('beforeunload', (e) => {
                saveAllData();
            });

            // 페이지 숨김 시에도 저장 (모바일 지원)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    saveAllData();
                }
            });
        }
        
        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            // 진행상태 토글 기본 열기
            document.getElementById('progressContent').classList.add('active');
            document.getElementById('progressArrow').classList.add('rotated');
            document.getElementById('progressArrow').textContent = '▲';
            
            // 저장된 데이터 확인
            const savedData = loadSavedState();
            
            if (savedData && savedData.isValid) {
                // 저장된 데이터가 있으면 복원 모달 표시
                showRestoreModal(savedData);
            } else {
                // 저장된 데이터가 없으면 새로 시작
                selectLevel('consonant');
                
                setTimeout(() => {
                    updateTutorMessage('👋 듣기 학습 시작!', 
                        '소리를 통해 한글을 배우는 특별한 시간이에요! 🎧 소리 듣기 버튼을 눌러서 시작해보세요! ✨');
                }, 1000);
            }
            
            // 자동 저장 시작
            startAutoSave();
            
            // 페이지 종료 시 저장 설정
            setupBeforeUnloadSave();
        });
        
        // 키보드 단축키
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                playCurrentSound();
            } else if (e.code === 'Enter') {
                e.preventDefault();
                nextQuestion();
            } else if (e.code === 'KeyH') {
                e.preventDefault();
                getTutorHelp();
            } else if (e.code === 'KeyS' && e.ctrlKey) {
                e.preventDefault();
                saveAllData();
                updateTutorMessage('💾 수동 저장', '진행상황이 저장되었어요! 👍');
            }
        });
    </script>
</body>
</html>